<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f4f7f6">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3135/3135715.png">
    
    <title>My Life Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        body { font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; background: #f4f7f6; padding: 15px; display: flex; flex-direction: column; align-items: center; -webkit-user-select: none; user-select: none; margin: 0; padding-bottom: 80px; }
        .container { max-width: 800px; width: 100%; }
        
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .full-width { width: 100%; box-sizing: border-box; }
        .check-in-box { background: linear-gradient(135deg, #e0f7fa 0%, #ffffff 100%); border: 2px solid #b2ebf2; }
        
        .asset-form { display: flex; flex-direction: column; gap: 15px; }
        .asset-form label { display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: #555; font-size: 0.95rem; }
        .asset-form input, .asset-form select { padding: 10px; border-radius: 8px; border: 1px solid #ddd; width: 55%; font-size: 16px; background: #f9f9f9; }

        button { border: none; padding: 12px 25px; border-radius: 50px; font-size: 1rem; cursor: pointer; transition: 0.2s; color: white; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        button:active { transform: scale(0.96); }
        button:disabled { background: #ccc !important; box-shadow: none; }

        .checkbox-group { display: flex; gap: 12px; margin: 15px 0; flex-wrap: wrap; }
        .checkbox-group label { font-size: 1rem; cursor: pointer; display: flex; align-items: center; background: rgba(255,255,255,0.6); padding: 5px 10px; border-radius: 20px; }
        .checkbox-group input { width: 22px; height: 22px; margin-right: 8px; }

        .progress-container { width: 100%; background-color: rgba(255,255,255,0.3); border-radius: 10px; margin-top: 15px; height: 8px; overflow: hidden; }
        .progress-bar { height: 100%; background-color: #4ade80; width: 0%; transition: width 1s ease-in-out; }

        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; }
        
        /* ğŸ“± åº•éƒ¨å°è¦½åˆ— */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; border-top: 1px solid #ddd;
            display: flex; justify-content: space-around; padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 1000;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            font-size: 0.8rem; color: #888; background: none; border: none; padding: 0; box-shadow: none;
        }
        .nav-item span { font-size: 1.5rem; margin-bottom: 2px; }
        .nav-item.active { color: #2a5298; font-weight: bold; }

        .view-section { display: none; animation: fadeIn 0.3s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 768px) {
            .grid-container { grid-template-columns: 1fr !important; }
            .asset-form label { flex-direction: column; align-items: flex-start; gap: 5px; }
            .asset-form input, .asset-form select { width: 100%; box-sizing: border-box; }
            h1 { display: none; } 
            #totalAssetsDisplay { font-size: 2.8rem !important; }
            .roi-box { flex-direction: row; justify-content: space-around; gap: 10px !important; }
            .roi-item div:first-child { font-size: 0.8rem; }
            .roi-item div:last-child { font-size: 1.1rem !important; }
        }
    </style>
</head>
<body>

<nav class="bottom-nav">
    <button class="nav-item active" onclick="switchTab('home')"><span>ğŸ </span>é¦–é </button>
    <button class="nav-item" onclick="switchTab('expenses')"><span>ğŸ’¸</span>è¨˜å¸³</button>
    <button class="nav-item" onclick="switchTab('assets')"><span>ğŸ’°</span>è³‡ç”¢</button>
    <button class="nav-item" onclick="switchTab('more')"><span>ğŸ”</span>æ›´å¤š</button>
</nav>

<div class="container">
    <h1 style="text-align:center; margin-bottom:20px;">ğŸš€ My Life Dashboard</h1>

    <div id="view-home" class="view-section active">
        
        <div class="card full-width" style="background: linear-gradient(135deg, #2c3e50 0%, #4ca1af 100%); color: white; padding: 20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 style="margin:0; font-size: 1.1rem; opacity: 0.9;">â³ æ™‚é–“å€’æ•¸</h2>
                <button onclick="toggleEventForm()" style="background: rgba(255,255,255,0.2); font-size: 0.8rem; padding: 5px 10px; border:1px solid rgba(255,255,255,0.5);">ï¼‹</button>
            </div>
            <div id="eventForm" style="display:none; background:rgba(0,0,0,0.2); padding:15px; border-radius:10px; margin-bottom:15px; flex-direction:column; gap:10px;">
                <input type="text" id="evtTitle" placeholder="åç¨±" style="padding:8px; border-radius:5px; border:none;">
                <input type="text" id="evtDate" placeholder="æ—¥æœŸ (YYYY-MM-DD)" style="padding:8px; border-radius:5px; border:none;">
                <select id="evtType" style="padding:8px; border-radius:5px; border:none;"><option value="fixed">ä¸€æ¬¡æ€§</option><option value="yearly">æ¯å¹´é‡è¤‡</option></select>
                <button onclick="submitEvent()" style="background: #4ca1af; color: white;">æ–°å¢</button>
            </div>
            <div id="timeContainer" style="display: flex; flex-direction: column; gap: 15px;">è¼‰å…¥ä¸­...</div>
        </div>

        <div class="card check-in-box">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 id="dateTitle" style="margin:0; font-size: 1.2rem;">ğŸ“… ä»Šå¤©æ‰“å¡</h2>
                <input type="date" id="habitDate" style="border: 1px solid #b2ebf2; padding: 5px 10px; border-radius: 8px; background: rgba(255,255,255,0.8); font-weight: bold; color: #00796b; width: auto;">
            </div>
            <div class="checkbox-group">
                <label><input type="checkbox" id="checkEnglish"> è‹±æ–‡</label>
                <label><input type="checkbox" id="checkExercise"> é‹å‹•ç¿’æ…£</label>
                <label><input type="checkbox" id="checkReading"> è®€æ›¸ç¿’æ…£</label>
                <label><input type="checkbox" id="checkSleeping"> ç¡è¦ºç¿’æ…£</label>
            </div>
            <button onclick="submitHabit()" id="submitBtn" style="background: #00897b; width:100%;">é€å‡ºç´€éŒ„</button>
            <span id="statusMsg" style="margin-left: 10px; color: #666;"></span>
        </div>

        <div class="card">
            <h2>ğŸ“ˆ èƒ½åŠ›æˆé•·æ›²ç·š</h2>
            <canvas id="habitChart"></canvas>
        </div>
    </div>

    <div id="view-expenses" class="view-section">
        
        <div class="grid-container">
            <div class="card" style="background: linear-gradient(135deg, #388e3c 0%, #81c784 100%); color: white; text-align: center; padding: 20px;">
                <h2 style="margin:0; font-size: 1rem; opacity: 0.9;">ğŸ’¸ ç”Ÿæ´»å¯ç”¨</h2>
                <div id="livingFundsDisplay" style="font-size: 2rem; font-weight: bold;">...</div>
            </div>
            <div class="card" style="background: linear-gradient(135deg, #e53935 0%, #e57373 100%); color: white; text-align: center; padding: 20px;">
                <h2 style="margin:0; font-size: 1rem; opacity: 0.9;">ğŸ“‰ æœ¬æœˆå·²èŠ±</h2>
                <div id="monthExpenseDisplay" style="font-size: 2rem; font-weight: bold;">...</div>
                
                <div style="margin-top: 10px;">
                    <div style="display:flex; justify-content:space-between; font-size:0.8em; opacity:0.9;"><span>é ç®— $<span id="budgetLimit">0</span></span><span id="budgetPercent">0%</span></div>
                    <div style="width:100%; background:rgba(255,255,255,0.3); border-radius:10px; height:6px; overflow:hidden; margin-top:5px;">
                        <div id="budgetBar" style="height:100%; background:#fff; width:0%;"></div>
                    </div>
                    <div id="budgetMessage" style="font-size:0.8em; margin-top:5px; font-weight:bold; text-align:right;">è¨ˆç®—ä¸­...</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ’¸ æ—¥å¸¸è¨˜å¸³</h2>
            <div class="asset-form">
                <label>æ—¥æœŸï¼š<input type="date" id="expDate"></label>
                <label>æ”¶æ”¯ï¼š<select id="expType"><option value="æ”¯å‡º">æ”¯å‡º</option><option value="æ”¶å…¥">æ”¶å…¥</option></select></label>
                <label>å¸³æˆ¶ï¼š
                    <select id="expAccount">
                        <option value="éŒ¢åŒ…">ç¾é‡‘éŒ¢åŒ…</option>
                        <option value="ä¸­åœ‹ä¿¡è¨—">ä¸­åœ‹ä¿¡è¨—</option>
                        <option value="æ‚ éŠå¡">æ‚ éŠå¡</option>
                        <option value="icash">icash</option>
                        <option value="ipassmoney">iPass Money</option>
                        <option value="å­¸ç”Ÿè­‰">å­¸ç”Ÿè­‰</option>
                        <option value="å¾…ä»˜æ¬¾">âš ï¸ å¾…ä»˜æ¬¾</option>
                    </select>
                </label>
                <label>é¡åˆ¥ï¼š<select id="expCategory"><option value="é£Ÿ">é£Ÿ</option><option value="è¡£">è¡£</option><option value="ä½">ä½</option><option value="è¡Œ">è¡Œ</option><option value="è‚²æ¨‚">è‚²æ¨‚</option><option value="å…¶ä»–">å…¶ä»–</option></select></label>
                <label>é …ç›®ï¼š<input type="text" id="expItem" placeholder="å¦‚: åˆé¤"></label>
                <label>é‡‘é¡ï¼š<input type="number" id="expAmount" placeholder="100"></label>
                <button onclick="submitExpense()" id="btnExp" style="background: #e91e63; width:100%;">è¨˜ä¸€ç­†</button>
            </div>
        </div>

        <div class="card" style="border-left: 5px solid #9c27b0;">
            <h2>ğŸ”„ è½‰å¸³ / é ˜éŒ¢</h2>
            <div class="asset-form">
                <label>æ—¥æœŸï¼š<input type="date" id="transDate"></label>
                <div style="display:flex; gap:10px;">
                    <select id="transFrom" style="width:100%">
                        <option value="éƒµå±€">éƒµå±€</option>
                        <option value="å¯Œé‚¦éŠ€è¡Œ">å¯Œé‚¦</option>
                        <option value="ä¸­åœ‹ä¿¡è¨—">ä¸­ä¿¡</option>
                        <option value="éŒ¢åŒ…">éŒ¢åŒ…</option>
                    </select>
                    <span>â¡</span>
                    <select id="transTo" style="width:100%">
                        <option value="éŒ¢åŒ…">éŒ¢åŒ…</option>
                        <option value="æ‚ éŠå¡">æ‚ éŠå¡</option>
                        <option value="icash">icash</option>
                        <option value="ipassmoney">iPass Money</option>
                        <option value="å­¸ç”Ÿè­‰">å­¸ç”Ÿè­‰</option>
                        <option value="å¾…ä»˜æ¬¾">é‚„å‚µ</option>
                        <option value="å¯Œé‚¦è­‰åˆ¸">è­‰åˆ¸</option>
                        <option value="ä¸­åœ‹ä¿¡è¨—">ä¸­åœ‹ä¿¡è¨—</option>
                        <option value="éƒµå±€">éƒµå±€</option>
                        <option value="å¯Œé‚¦éŠ€è¡Œ">å¯Œé‚¦</option>
                    </select>
                </div>
                <label>é‡‘é¡ï¼š<input type="number" id="transAmount" placeholder="1000"></label>
                <button onclick="submitTransfer()" id="btnTrans" style="background: #9c27b0; width:100%;">ç¢ºèª</button>
            </div>
        </div>

        <div class="card full-width">
            <h2>ğŸ“Š æœ¬æœˆ vs ä¸Šæœˆ æ”¯å‡ºæ¯”è¼ƒ</h2>
            
            <div class="grid-container">
                <div style="height: 250px;">
                    <canvas id="expenseCompareChart"></canvas>
                </div>
                
                <div>
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                        <thead>
                            <tr style="border-bottom: 2px solid #ddd; text-align: left;">
                                <th style="padding: 8px;">é¡åˆ¥</th>
                                <th style="padding: 8px; color: #36a2eb;">æœ¬æœˆ</th>
                                <th style="padding: 8px; color: #ff6384;">ä¸Šæœˆ</th>
                            </tr>
                        </thead>
                        <tbody id="compareTableBody">
                            </tbody>
                    </table>

                    <div style="margin-top: 15px;">
                        <div style="padding: 8px; background: #fce4ec; border-radius: 5px; color: #c2185b; margin-bottom:5px; font-size: 0.9em;">
                            ğŸ“… ä¸Šæœˆç¸½æ”¯å‡ºï¼š<b id="lastMonthTotalDisplay">...</b>
                        </div>
                        <div style="padding: 8px; background: #fff3cd; border-radius: 5px; color: #856404; font-size: 0.9em;">
                            ğŸ’¡ å·®ç•°ï¼š<b id="totalDiff">...</b>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h2 style="margin:0;">ğŸ“ æœ€è¿‘ç´€éŒ„</h2>
                <select id="recordFilter" onchange="renderExpenseList()" style="padding:5px; border-radius:5px; border:1px solid #ddd; background:#f9f9f9; font-size:0.85em;">
                    <option value="ALL">å…¨éƒ¨é¡¯ç¤º</option>
                    <optgroup label="ğŸ“‚ ä¾é¡åˆ¥">
                        <option value="CAT_é£Ÿ">é£Ÿ</option>
                        <option value="CAT_è¡£">è¡£</option>
                        <option value="CAT_ä½">ä½</option>
                        <option value="CAT_è¡Œ">è¡Œ</option>
                        <option value="CAT_è‚²æ¨‚">è‚²æ¨‚</option>
                        <option value="CAT_å…¶ä»–">å…¶ä»–</option>
                    </optgroup>
                    <optgroup label="ğŸ’³ ä¾å¸³æˆ¶">
                        <option value="ACC_éŒ¢åŒ…">éŒ¢åŒ…</option>
                        <option value="ACC_ä¸­åœ‹ä¿¡è¨—">ä¸­åœ‹ä¿¡è¨—</option>
                        <option value="ACC_å­¸ç”Ÿè­‰">å­¸ç”Ÿè­‰</option>
                        <option value="ACC_éƒµå±€">éƒµå±€</option>
                        <option value="ACC_å¯Œé‚¦éŠ€è¡Œ">å¯Œé‚¦éŠ€è¡Œ</option>
                        <option value="ACC_æ‚ éŠå¡">æ‚ éŠå¡</option>
                        <option value="ACC_icash">icash</option>
                        <option value="ACC_ipassmoney">iPass Money</option>
                        <option value="ACC_å¾…ä»˜æ¬¾">å¾…ä»˜æ¬¾</option>
                    </optgroup>
                </select>
            </div>
            <ul id="expenseList" style="list-style: none; padding: 0; max-height: 300px; overflow-y: auto;">
                <li style="color:#888;">è¼‰å…¥ä¸­...</li>
            </ul>
        </div>
    </div>

    <div id="view-assets" class="view-section">
        
        <div class="card full-width" style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; text-align: center; padding: 30px;">
            <h2 style="margin:0; font-size: 1.2rem; opacity: 0.8;">ğŸ’° ç¸½è³‡ç”¢æ·¨å€¼</h2>
            <div id="totalAssetsDisplay" style="font-size: 3.5rem; font-weight: bold; margin: 10px 0;">è¨ˆç®—ä¸­...</div>
            
            <div style="margin-top: 20px; text-align: left;">
                <div style="display: flex; justify-content: space-between; font-size: 0.9em; opacity: 0.9; margin-bottom: 5px;">
                    <span>ğŸ¯ ç¬¬ä¸€æ¡¶é‡‘ç›®æ¨™</span><span id="goalPercent">0%</span>
                </div>
                <div class="progress-container"><div id="goalProgressBar" class="progress-bar"></div></div>
                <div id="predictionText" style="font-size: 0.85em; color: #ccc; margin-top: 8px; text-align: right;">åˆ†æä¸­...</div>
            </div>

            <div class="roi-box" style="display: flex; justify-content: center; gap: 30px; margin-top: 25px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px; flex-wrap: wrap;">
                <div class="roi-item" style="text-align: center;">
                    <div style="font-size: 0.9rem; opacity: 0.8;">æˆæœ¬</div><div id="totalCostDisplay" style="font-size: 1.2rem; font-weight: bold;">$0</div>
                </div>
                <div class="roi-item" style="text-align: center;">
                    <div style="font-size: 0.9rem; opacity: 0.8;">æç›Š</div><div id="totalProfitDisplay" style="font-size: 1.2rem; font-weight: bold;">$0</div>
                </div>
                <div class="roi-item" style="text-align: center;">
                    <div style="font-size: 0.9rem; opacity: 0.8;">ROI</div><div id="roiDisplay" style="font-size: 1.2rem; font-weight: bold; color: #4ade80;">0%</div>
                </div>
            </div>
        </div>

        <div class="card full-width">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h2>ğŸ“ˆ è³‡ç”¢è¶¨å‹¢</h2>
                <button onclick="snapshotAssets()" id="btnSnapshot" style="background: #6c757d; font-size: 0.8rem; padding: 5px 15px;">ğŸ“¸ å¿«ç…§</button>
            </div>
            <div style="height: 300px;"><canvas id="trendChart"></canvas></div>
        </div>

        <div class="card">
            <h2>ğŸ“Š é…ç½®æ¯”ä¾‹</h2>
            <div style="height: 300px;"><canvas id="assetPieChart"></canvas></div>
        </div>

        <div class="card full-width">
            <h2>ğŸ“œ æŒè‚¡æ˜ç´° (åº«å­˜)</h2>
            <table style="width:100%; border-collapse: collapse; font-size: 0.9em;">
                <thead>
                    <tr style="border-bottom: 2px solid #ddd; text-align: left; color: #666;">
                        <th style="padding: 10px 5px;">é …ç›®</th>
                        <th style="padding: 10px 5px; text-align: right;">æŒæœ‰æ•¸é‡</th>
                        <th style="padding: 10px 5px; text-align: right;">ç¾å€¼</th>
                    </tr>
                </thead>
                <tbody id="holdingsTableBody">
                    <tr><td colspan="3" style="text-align:center; color:#999; padding:20px;">è¼‰å…¥ä¸­...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="card">
            <h2>ğŸ’µ æ¯æœˆæ”¶å…¥</h2>
            <div style="height: 250px;"><canvas id="incomeSourceChart"></canvas></div>
        </div>

        <div class="card full-width" style="border-left: 5px solid #fbc02d;">
            <h2>âœï¸ è‚¡ç¥¨/å¤§é¡äº¤æ˜“</h2>
            <div class="asset-form">
                <label>æ—¥æœŸï¼š<input type="date" id="assetDate"></label>
                <label>å¸³æˆ¶ï¼š
                    <select id="assetAccount"><option value="å¯Œé‚¦è­‰åˆ¸">å¯Œé‚¦è­‰åˆ¸</option><option value="éƒµå±€">éƒµå±€</option><option value="å¯Œé‚¦éŠ€è¡Œ">å¯Œé‚¦éŠ€è¡Œ</option></select>
                </label>
                <label>é¡åˆ¥ï¼š
                    <select id="assetCategory"><option value="è‚¡ç¥¨">è‚¡ç¥¨</option><option value="ç¾é‡‘">ç¾é‡‘</option><option value="åŠ å¯†è²¨å¹£">åŠ å¯†è²¨å¹£</option></select>
                </label>
                <label>é …ç›®ï¼š<input type="text" id="assetItem" placeholder="0050"></label>
                <label>æ•¸é‡ï¼š<input type="number" id="assetQty" placeholder="è‚¡æ•¸"></label>
                <label>é‡‘é¡ï¼š<input type="number" id="assetAmount" placeholder="ç¸½åƒ¹"></label>
                <label>å‹æ…‹ï¼š
                    <select id="assetType"><option value="æµå…¥">è²·å…¥ (+)</option><option value="æµå‡º">è³£å‡º (-)</option></select>
                </label>
                <button onclick="submitAsset()" id="btnAsset" style="background: #fbc02d; color: black; width:100%;">æ–°å¢ç´€éŒ„</button>
            </div>
        </div>
    </div>

    <div id="view-more" class="view-section">

        <div class="card full-width" style="border-left: 5px solid #2196F3;">
            <h2>ğŸ’³ å¸³æˆ¶é¤˜é¡å°å¸³</h2>
            <div id="accountBalanceContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px;">
                <div style="color: #888;">è¨ˆç®—ä¸­...</div>
            </div>
        </div>
        
        <div class="card full-width" style="border-left: 5px solid #ff9800;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2>ğŸ›ï¸ å¤¢æƒ³è³¼ç‰©è»Š</h2>
                <button onclick="toggleWishForm()" style="background: #ff9800; font-size: 0.8rem; padding: 5px 10px;">ï¼‹ è¨±é¡˜</button>
            </div>
            <div id="wishForm" class="asset-form" style="display:none; background:#fff3e0; padding:15px; border-radius:10px; margin-bottom:20px;">
                <input type="text" id="wishItem" placeholder="æƒ³è²·ä»€éº¼ï¼Ÿ">
                <input type="number" id="wishAmount" placeholder="åƒ¹æ ¼">
                <input type="text" id="wishNote" placeholder="å‚™è¨»">
                <button onclick="submitWish()" style="background: #ff9800; color: white;">åŠ å…¥æ¸…å–®</button>
            </div>
            <div id="wishlistContainer" style="display: flex; flex-direction: column; gap: 10px;">è¼‰å…¥ä¸­...</div>
        </div>

        <div class="card full-width" style="border-left: 5px solid #607d8b;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2>ğŸ“š çŸ¥è­˜æ›¸æ«ƒ</h2>
                <button onclick="toggleMediaForm()" style="background: #607d8b; font-size: 0.8rem; padding: 5px 15px;">ï¼‹</button>
            </div>
            <div id="mediaForm" class="asset-form" style="display:none; background:#f0f4f8; padding:15px; border-radius:10px; margin-bottom:20px;">
                <input type="date" id="mediaDate">
                <select id="mediaType"><option value="æ›¸ç±">æ›¸ç±</option><option value="å½±ç‰‡">å½±ç‰‡</option><option value="èª²ç¨‹">èª²ç¨‹</option><option value="å‹•æ¼«">å‹•æ¼«</option></select>
                <input type="text" id="mediaTitle" placeholder="æ¨™é¡Œ">
                <select id="mediaRating"><option value="5">â­â­â­â­â­</option><option value="4">â­â­â­â­</option><option value="3">â­â­â­</option><option value="2">â­â­</option><option value="1">â­</option></select>
                <input type="text" id="mediaComment" placeholder="å¿ƒå¾—">
                <button onclick="submitMedia()" style="background: #607d8b; color: white;">å„²å­˜</button>
            </div>
            <div id="mediaContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">è¼‰å…¥ä¸­...</div>
        </div>
        
    </div>

</div>

<script>
    // ==========================================
    // ğŸŸ¢ æ™ºæ…§ç™»å…¥ç³»çµ± 
    // ==========================================
    
    // 1. å˜—è©¦å¾ç€è¦½å™¨è¨˜æ†¶é«” (LocalStorage) æŠ“å–è¨­å®š
    let savedUrl = localStorage.getItem("MY_DASHBOARD_URL");
    let savedPass = localStorage.getItem("MY_DASHBOARD_PASS");

    // 2. å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨ (æ²’å­˜é)ï¼Œè·³å‡ºè©¢å•è¦–çª—
    if (!savedUrl || !savedPass) {
        alert("ğŸ‘‹ æ­¡è¿ï¼é€™æ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œè«‹é€²è¡Œåˆå§‹è¨­å®šã€‚");
        
        let inputUrl = prompt("è«‹è²¼ä¸Šæ‚¨çš„ GAS éƒ¨ç½²ç¶²å€ (script.google.com...):");
        if (inputUrl) {
            inputUrl = inputUrl.trim();
            localStorage.setItem("MY_DASHBOARD_URL", inputUrl); 
            savedUrl = inputUrl;
        }

        let inputPass = prompt("è«‹è¨­å®šä¸€çµ„ç™»å…¥å¯†ç¢¼ (ä»¥å¾Œç”¨é€™çµ„è§£é–):");
        if (inputPass) {
            inputPass = inputPass.trim();
            localStorage.setItem("MY_DASHBOARD_PASS", inputPass); 
            savedPass = inputPass;
        }
    }

    // 3. æª¢æŸ¥æ˜¯å¦è¨­å®šå®Œæˆ
    if (!savedUrl || !savedPass) {
        alert("âš ï¸ è¨­å®šæœªå®Œæˆï¼Œç„¡æ³•è¼‰å…¥ã€‚è«‹é‡æ–°æ•´ç†ç¶²é å†è©¦ä¸€æ¬¡ã€‚");
        throw new Error("Setup Incomplete");
    }

    // 4. æ¯æ—¥ç™»å…¥æª¢æŸ¥
    const inputCheck = prompt("ğŸ”’ è«‹è¼¸å…¥å¯†ç¢¼è§£é–è³‡ç”¢ç”Ÿæ´»ç´€éŒ„ç‰ˆï¼š");
    if (inputCheck !== savedPass) {
        document.body.innerHTML = `
            <div style='display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;text-align:center;'>
                <h1>â›”ï¸ å¯†ç¢¼éŒ¯èª¤</h1>
                <p>å­˜å–è¢«æ‹’çµ•ã€‚</p>
                <button onclick='localStorage.clear();location.reload();' style='padding:10px 20px;font-size:1rem;cursor:pointer;'>é‡è¨­æ‰€æœ‰è¨­å®š (å¿˜è¨˜å¯†ç¢¼é»æˆ‘)</button>
            </div>
        `;
        throw new Error("Access Denied");
    }

    // ğŸŸ¢ åˆ†é åˆ‡æ›åŠŸèƒ½
    function switchTab(tabId) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById('view-' + tabId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
        window.dispatchEvent(new Event('resize'));
    }

    // 5. è¨­å®šå…¨åŸŸè®Šæ•¸
    const API_URL = savedUrl;
    const SAVING_GOAL = 1000000; // ä½ çš„ç¬¬ä¸€æ¡¶é‡‘ç›®æ¨™
    const MONTHLY_BUDGET = 15000; // æ¯æœˆç¸½é ç®—

    // ==========================================
    // ğŸŸ¢ åœ–è¡¨æ¨™ç±¤è¨­å®š
    // ==========================================
    Chart.register(ChartDataLabels);
    Chart.defaults.set('plugins.datalabels', { display: false }); 

    let myChart = null; let assetChart = null; let incomeChart = null; let compareChart = null; let trendChart = null;
    let globalSnapshotData = []; 
    let globalTotalAssets = 0; 
    let globalLivingFunds = 0;
    let globalExpensesData = [];

    // --- è¬ç”¨æ—¥æœŸæ ¼å¼åŒ–å‡½å¼ (YYYY/MM/DD) ---
    function formatDate(dateInput) {
        if (!dateInput) return "";
        try {
            let d = new Date(dateInput);
            if (isNaN(d.getTime()) && typeof dateInput === 'string') {
                let parts = dateInput.split(/[-/]/);
                let y = parts.length === 3 ? parts[0] : new Date().getFullYear();
                let m = parts.length === 3 ? parts[1] : parts[0];
                let day = parts.length === 3 ? parts[2] : parts[1];
                d = new Date(y, m - 1, day);
            }
            if (isNaN(d.getTime())) return dateInput;
            let yyyy = d.getFullYear();
            let mm = String(d.getMonth() + 1).padStart(2, '0');
            let dd = String(d.getDate()).padStart(2, '0');
            return `${yyyy}/${mm}/${dd}`;
        } catch (e) {
            return dateInput;
        }
    }

    window.onload = function() {
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0]; 
        
        // è¨­å®šæ‰€æœ‰æ—¥æœŸè¼¸å…¥æ¡†é è¨­å€¼
        const dateInputs = ['habitDate','assetDate','expDate','transDate','mediaDate','evtDate'];
        dateInputs.forEach(id => { 
            let el = document.getElementById(id); 
            if(el) el.value = todayStr; 
        });
        
        // è¼‰å…¥æ‰€æœ‰è³‡æ–™
        loadChart();             
        loadAssetChart();        
        loadExpenses();          
        loadExpenseComparison(); 
        loadMonthlyIncome();     
        loadAccountBalances();
        loadTrendChart(); 
        loadMediaList();
        loadTimeWidget();
    };

    // --- åŠŸèƒ½ 1ï¼šç¿’æ…£æ‰“å¡ ---
    function submitHabit() {
        const btn = document.getElementById('submitBtn');
        const msg = document.getElementById('statusMsg');
        const dateVal = document.getElementById('habitDate').value;
        
        if (!dateVal) { alert("è«‹é¸æ“‡æ—¥æœŸ"); return; }

        btn.innerText = "å¯«å…¥ä¸­..."; 
        btn.disabled = true;

        const payload = {
            tab: "Habit_Log",
            date: dateVal,
            english: document.getElementById('checkEnglish').checked,
            exercise: document.getElementById('checkExercise').checked,
            reading: document.getElementById('checkReading').checked,
            sleeping: document.getElementById('checkSleeping').checked
        };

        fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) })
        .then(res => res.text()).then(data => {
            if(data.includes("Success")) {
                btn.innerText = "âœ… å®Œæˆ";
                msg.innerText = "ç´€éŒ„æˆåŠŸï¼";
                setTimeout(() => { 
                    loadChart(); 
                    btn.disabled = false; 
                    btn.innerText = "é€å‡ºç´€éŒ„"; 
                    msg.innerText = ""; 
                }, 1500);
            } else { 
                alert("å¤±æ•—ï¼š" + data); 
                btn.disabled = false; 
                btn.innerText = "é€å‡ºç´€éŒ„";
            }
        });
    }

    // --- åŠŸèƒ½ 2ï¼šç¿’æ…£åœ– ---
    function loadChart() {
        fetch(API_URL + "?tab=Habit_Log").then(res => res.json()).then(data => {
            if(data.length === 0) return;
            const recentData = data.slice(-30); 
            const dates = recentData.map(d => formatDate(d.æ—¥æœŸ));

            function getHabitTrend(columnName) {
                let score = 100;
                return recentData.map(d => {
                    let val = d[columnName];
                    let isSuccess = (val === true || val === "TRUE" || val === "True");
                    score *= (isSuccess ? 1.01 : 0.99);
                    return score.toFixed(2);
                });
            }

            const ctx = document.getElementById('habitChart');
            if(myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        { label: 'è‹±æ–‡', data: getHabitTrend('è‹±æ–‡'), borderColor: '#FF6384', tension: 0.3 },
                        { label: 'é‹å‹•', data: getHabitTrend('é‹å‹•ç¿’æ…£'), borderColor: '#36A2EB', tension: 0.3 },
                        { label: 'è®€æ›¸', data: getHabitTrend('è®€æ›¸ç¿’æ…£'), borderColor: '#4BC0C0', tension: 0.3 },
                        { label: 'ç¡è¦º', data: getHabitTrend('ç¡è¦ºç¿’æ…£'), borderColor: '#9966FF', tension: 0.3 }
                    ]
                },
                options: { scales: { y: { suggestedMin: 90 } }, plugins: { tooltip: { mode: 'index', intersect: false } } }
            });
        });
    }

    // --- åŠŸèƒ½ 3ï¼šè³‡ç”¢äº¤æ˜“ ---
    function submitAsset() {
        const btn = document.getElementById('btnAsset');
        const vals = {
            tab: "Asset_Log", 
            date: document.getElementById('assetDate').value || new Date().toISOString().split('T')[0],
            account: document.getElementById('assetAccount').value, 
            category: document.getElementById('assetCategory').value,
            item: document.getElementById('assetItem').value, 
            qty: document.getElementById('assetQty').value,
            amount: document.getElementById('assetAmount').value, 
            type: document.getElementById('assetType').value
        };
        if(!vals.item || !vals.amount) { alert("è«‹è¼¸å…¥é …ç›®å’Œé‡‘é¡"); return; }
        
        btn.innerText = "å¯«å…¥ä¸­..."; btn.disabled = true;
        
        if (vals.type.includes("æµå‡º")) vals.amount = -Math.abs(vals.amount); 
        else vals.amount = Math.abs(vals.amount);
        
        fetch(API_URL, { method: 'POST', body: JSON.stringify(vals) }).then(res => res.text()).then(data => {
            if (data.includes("Success")) { 
                alert("ğŸ’° è³‡ç”¢ç´€éŒ„æˆåŠŸï¼"); 
                btn.innerText = "æ–°å¢è³‡ç”¢ç´€éŒ„"; btn.disabled = false; 
                document.getElementById('assetItem').value = ""; 
                document.getElementById('assetAmount').value = ""; 
                loadAssetChart(); loadMonthlyIncome(); loadAccountBalances(); 
            } else { 
                alert("å¤±æ•—ï¼š" + data); btn.disabled = false; 
            }
        });
    }

    // --- åŠŸèƒ½ 4ï¼šè³‡ç”¢åœ“é¤…åœ–èˆ‡åˆ—è¡¨ (çµ‚æ¥µç²¾ç¢ºç‰ˆï¼šåŒ…å«å·²å¯¦ç¾äº¤æ˜“æç›Š) ---
function loadAssetChart() {
    Promise.all([
        fetch(API_URL + "?tab=Portfolio").then(res => res.json()),
        fetch(API_URL + "?tab=Asset_Log").then(res => res.json())
    ]).then(([portfolioData, logData]) => {
        
        // --- è®Šæ•¸åˆå§‹åŒ– ---
        let currentTotalAssets = 0; // ç¸½è³‡ç”¢ (å«éŠ€è¡Œ/éƒµå±€)
        let investMarketValue = 0;  // æŠ•è³‡ç¾å€¼ (åªå«è‚¡ç¥¨/å¹£)
        
        // 1. æˆæœ¬é¢ (ä¾†è‡ª Asset_Log å¯Œé‚¦è­‰åˆ¸)
        let remainingCost = 0;      // å‰©é¤˜åº«å­˜æˆæœ¬ (å¯Œé‚¦è­‰åˆ¸ Net Sum)
        let soldCost = 0;           // å·²è³£å‡ºè‚¡ç¥¨çš„æˆæœ¬ (å¯Œé‚¦è­‰åˆ¸ è² æ•¸çš„çµ•å°å€¼)
        
        // 2. æ”¶å…¥é¢ (ä¾†è‡ª Asset_Log éŠ€è¡Œç«¯)
        let totalDividends = 0;     // è‚¡åˆ©
        let sellIncome = 0;         // è³£è‚¡æ”¶åˆ°çš„ç¾é‡‘ (äº¤æ˜“æ”¶å…¥)
        
        let categoryMap = {};       
        
        // --- æ­¥é©Ÿ 1: è™•ç† Asset_Log (æ‹†è§£ æˆæœ¬ èˆ‡ æ”¶å…¥) ---
        logData.forEach(row => {
            let account = (row['å¸³æˆ¶'] || "").toString();
            let amount = Number(row['é‡‘é¡'] || 0);
            let name = (row['é …ç›®åç¨±'] || "").toString();
            let cat = row['è³‡ç”¢é¡åˆ¥'];
            let type = row['äº¤æ˜“å‹æ…‹']; // "æµå…¥" æˆ– "æµå‡º"
            
            if (name && cat) categoryMap[name] = cat;

            // --- A. è™•ç†æˆæœ¬ (å¯Œé‚¦è­‰åˆ¸) ---
            if (account === "å¯Œé‚¦è­‰åˆ¸") {
                // 1. ç´¯åŠ å‰©é¤˜æˆæœ¬ (è²·é€²æ˜¯æ­£ï¼Œè³£å‡ºæ˜¯è² ï¼ŒåŠ ç¸½=å‰©é¤˜æˆæœ¬)
                remainingCost += amount;
                
                // 2. çµ±è¨ˆå·²è³£å‡ºçš„æˆæœ¬ (æŠ“å‡ºè² æ•¸çš„éƒ¨åˆ†)
                if (amount < 0) {
                    soldCost += Math.abs(amount); // è½‰æˆæ­£æ•¸ï¼Œä»£è¡¨ã€Œé€™ç­†äº¤æ˜“çš„æˆæœ¬æ˜¯å¤šå°‘ã€
                }
            } 
            // --- B. è™•ç†æ”¶å…¥ (éè­‰åˆ¸å¸³æˆ¶ï¼Œå¦‚å¯Œé‚¦éŠ€è¡Œ) ---
            else {
                // 3. æŠ“è‚¡åˆ©
                if (name.includes("è‚¡åˆ©")) {
                    totalDividends += amount;
                }
                // 4. æŠ“è³£å‡ºæ”¶å…¥
                // é‚è¼¯ï¼šå¦‚æœæ˜¯è‚¡ç¥¨/å¹£ ä¸” æ˜¯æµå…¥ ä¸” ä¸æ˜¯è‚¡åˆ© -> è¦–ç‚ºè³£å‡ºæ”¶å…¥
                // (æˆ–è€…æ‚¨å¯ä»¥æ˜ç¢ºæœå°‹åç¨±åŒ…å« "è³£å‡º" çš„é …ç›®)
                let isInvestItem = name.match(/00|Stock|BTC|ETH|é»ƒé‡‘|è³£å‡º/);
                if (isInvestItem && type === "æµå…¥" && !name.includes("è‚¡åˆ©")) {
                    sellIncome += amount;
                }
            }
        });

        // Debug: çœ‹çœ‹æŠ“åˆ°çš„æ•¸å­—å°ä¸å°
        console.log("å‰©é¤˜æˆæœ¬:", remainingCost);
        console.log("å·²å¯¦ç¾äº¤æ˜“ -> æ”¶å…¥:", sellIncome, " æˆæœ¬:", soldCost);
        console.log("äº¤æ˜“æç›Š:", sellIncome - soldCost);

        // --- æ­¥é©Ÿ 2: è™•ç† Portfolio ---
        let labels = [], values = [], colors = [];
        const palette = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF', '#E7E9ED', '#76D7C4', '#F1948A'];
        
        globalSnapshotData = []; 
        let tableHtml = "";

        portfolioData.forEach((row, i) => {
            let itemName = (row['é …ç›®åç¨±'] || "").toString();
            let mv = Number(row['ç¸½å¸‚å€¼'] || 0);
            let qty = Number(row['æŒæœ‰æ•¸é‡'] || 0);
            let priceNow = Number(row['å³æ™‚å–®åƒ¹'] || 0); 
            let priceYest = Number(row['æ˜¨æ—¥æ”¶ç›¤'] || row['å³æ™‚å–®åƒ¹'] || 0); 
            
            let isCashSavings = itemName.includes("éƒµå±€") || itemName.includes("å¯Œé‚¦éŠ€è¡Œ") || itemName.includes("ç¾é‡‘");

            if (mv > 0) {
                currentTotalAssets += mv;
                
                // è¨ˆç®—æœªå¯¦ç¾æç›Šç”¨çš„ã€Œç¾å€¼ã€ (æ’é™¤å­˜æ¬¾)
                if (!isCashSavings) {
                    investMarketValue += mv;
                }

                labels.push(itemName); 
                values.push(mv); 
                colors.push(palette[i % palette.length]);
                globalSnapshotData.push({ item: itemName, qty: qty, mv: mv, cost: 0 });

                let unit = "å–®ä½";
                if (itemName.match(/00|Stock/)) unit = "è‚¡";
                else if (itemName.match(/BTC|ETH/)) unit = "é¡†";
                else if (itemName.match(/é»ƒé‡‘/)) unit = "å…‹";
                let qtyDisplay = (unit === "è‚¡") ? qty.toLocaleString() : qty;

                let dayChange = (priceNow - priceYest) * qty;
                let changeColor = dayChange > 0 ? "#ff4d4f" : (dayChange < 0 ? "#52c41a" : "#999");
                let changeSign = dayChange > 0 ? "â–² +" : (dayChange < 0 ? "â–¼ " : "");
                let showChange = (dayChange !== 0 && Math.abs(priceNow - 1) > 0.01 && !isCashSavings);

                let changeText = showChange ? 
                    `<div style="color:${changeColor}; font-size:0.85em; margin-top:3px;">${changeSign}$${Math.abs(Math.round(dayChange)).toLocaleString()}</div>` : 
                    `<div style="color:#ccc; font-size:0.8em; margin-top:3px;">-</div>`;

                tableHtml += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 12px 5px; font-weight:bold; color:#333;">
                            <span style="display:inline-block; width:10px; height:10px; background:${palette[i % palette.length]}; margin-right:5px; border-radius:50%;"></span>
                            ${itemName}
                        </td>
                        <td style="padding: 12px 5px; text-align: right; color:#555;">${qtyDisplay} <span style="font-size:0.8em; color:#999;">${unit}</span></td>
                        <td style="padding: 12px 5px; text-align: right;">
                            <div style="font-weight:bold;">$${mv.toLocaleString()}</div>${changeText}
                        </td>
                    </tr>`;
            }
        });
        
        // --- æ­¥é©Ÿ 3: æœ€çµ‚è¨ˆç®— ---
        const tableBody = document.getElementById('holdingsTableBody');
        if(tableBody) tableBody.innerHTML = tableHtml || "<tr><td colspan='3' style='text-align:center;'>ç„¡è³‡ç”¢</td></tr>";

        // 1. ç¸½è³‡ç”¢
        globalTotalAssets = currentTotalAssets;
        document.getElementById('totalAssetsDisplay').innerText = "$" + currentTotalAssets.toLocaleString();
        
        let percent = Math.min(100, Math.round((currentTotalAssets / SAVING_GOAL) * 100));
        document.getElementById('goalProgressBar').style.width = percent + "%";
        document.getElementById('goalPercent').innerText = percent + "%";
        
        // 2. ç¸½æˆæœ¬ (é¡¯ç¤ºç›®å‰åº«å­˜çš„æˆæœ¬)
        document.getElementById('totalCostDisplay').innerText = "$" + remainingCost.toLocaleString();
        
        // 3. ç¸½æç›Š (Total Profit)
        // å…¬å¼ = (æœªå¯¦ç¾æç›Š) + (å·²å¯¦ç¾äº¤æ˜“æç›Š) + (è‚¡åˆ©)
        // æœªå¯¦ç¾ = investMarketValue - remainingCost
        // å·²å¯¦ç¾äº¤æ˜“ = sellIncome - soldCost
        
        let unrealizedProfit = investMarketValue - remainingCost;
        let realizedTradingProfit = sellIncome - soldCost;
        
        let totalProfit = unrealizedProfit + realizedTradingProfit + totalDividends;
        
        // 4. ROI
        // åˆ†æ¯ä½¿ç”¨ remainingCost ä»£è¡¨ã€Œç›®å‰æŠ•å…¥çš„è³‡é‡‘æ•ˆç‡ã€
        // æˆ–è€…ä½¿ç”¨ (remainingCost + soldCost) ä»£è¡¨ã€Œæ­·å²ç¸½æŠ•å…¥ã€ï¼Œé€šå¸¸çœ‹ç›®å‰åº«å­˜æœƒç”¨ remainingCost
        let roiBase = remainingCost > 0 ? remainingCost : 1; 
        let roi = (totalProfit / roiBase) * 100;
        
        let pEl = document.getElementById('totalProfitDisplay');
        pEl.innerText = (totalProfit >= 0 ? "+" : "") + "$" + totalProfit.toLocaleString();
        pEl.style.color = totalProfit >= 0 ? "#ff9999" : "#99ff99";

        let rEl = document.getElementById('roiDisplay');
        rEl.innerText = (roi === 999 ? "âˆ" : ((roi >= 0 ? "+" : "") + roi.toFixed(2))) + "%";
        rEl.style.color = roi >= 0 ? "#ff9999" : "#99ff99";

        // æ›´æ–°åœ–è¡¨
        const ctx = document.getElementById('assetPieChart');
        if(assetChart) assetChart.destroy();
        assetChart = new Chart(ctx, { type: 'doughnut', data: { labels: labels, datasets: [{ data: values, backgroundColor: colors }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' }, datalabels: { display: true, color: '#fff', font: { weight: 'bold', size: 11 }, formatter: (value, ctx) => { let sum = 0; let dataArr = ctx.chart.data.datasets[0].data; dataArr.map(data => { sum += data; }); let percentage = (value * 100 / sum).toFixed(1) + "%"; if((value * 100 / sum) < 3) return ""; return percentage; } } } } });
    });
}

    // --- åŠŸèƒ½ 5ï¼šé€å‡ºæ—¥å¸¸è¨˜å¸³ ---
    function submitExpense() {
        const btn = document.getElementById('btnExp');
        const vals = { 
            tab: "Expenses_DB", 
            date: document.getElementById('expDate').value, 
            type: document.getElementById('expType').value, 
            account: document.getElementById('expAccount').value, 
            category: document.getElementById('expCategory').value, 
            item: document.getElementById('expItem').value, 
            amount: document.getElementById('expAmount').value 
        };
        if(!vals.item || !vals.amount) { alert("è«‹è¼¸å…¥é …ç›®å’Œé‡‘é¡"); return; }
        btn.innerText = "å¯«å…¥ä¸­..."; btn.disabled = true;
        fetch(API_URL, { method: 'POST', body: JSON.stringify(vals) }).then(res => res.text()).then(data => {
            if (data.includes("Success")) { 
                alert("ğŸ’¸ è¨˜å¸³æˆåŠŸï¼"); 
                btn.disabled = false; btn.innerText = "è¨˜ä¸€ç­†"; 
                document.getElementById('expItem').value = ""; 
                document.getElementById('expAmount').value = ""; 
                loadExpenses(); loadExpenseComparison(); loadAccountBalances(); loadTrendChart(); 
            } else { alert("å¤±æ•—ï¼š" + data); btn.disabled = false; }
        });
    }

    // --- åŠŸèƒ½ 6 (å®Œå…¨é«”)ï¼šè®€å–è¨˜å¸³ + ç¯©é¸ + åˆªé™¤æŒ‰éˆ• ---
    
    // 1. ä¸‹è¼‰ä¸¦å­˜æª”
    function loadExpenses() {
        fetch(API_URL + "?tab=Expenses_DB").then(res => res.json()).then(data => {
            globalExpensesData = data; // å­˜å…¥å…¨åŸŸè®Šæ•¸
            renderExpenseList();       // åˆå§‹ç¹ªè£½
        });
    }

    // 2. æ¸²æŸ“åˆ—è¡¨ (åŒ…å«ç¯©é¸é‚è¼¯ & åˆªé™¤æŒ‰éˆ•)
    function renderExpenseList() {
        const list = document.getElementById('expenseList'); 
        // æŠ“å–ä¸‹æ‹‰é¸å–®çš„å€¼ï¼Œå¦‚æœ HTML é‚„æ²’æ›´æ–°é¸å–®ï¼Œå°±é è¨­ "ALL"
        const filterEl = document.getElementById('recordFilter');
        const filterVal = filterEl ? filterEl.value : "ALL"; 
        
        list.innerHTML = ""; 
        
        if(globalExpensesData.length === 0) { 
            list.innerHTML = "<li style='color:#ccc'>ç„¡ç´€éŒ„</li>"; 
            return; 
        }

        // --- æ ¸å¿ƒç¯©é¸é‚è¼¯ ---
        let filteredData = globalExpensesData.filter(row => {
            if (filterVal === "ALL") return true; 
            if (filterVal.startsWith("CAT_")) return row.é¡åˆ¥ === filterVal.replace("CAT_", "");
            if (filterVal.startsWith("ACC_")) return row.å¸³æˆ¶ === filterVal.replace("ACC_", "");
            return true;
        });

        // å–æœ€å¾Œ 10 ç­†ä¸¦åè½‰
        const displayData = filteredData.slice(-10).reverse();

        if (displayData.length === 0) {
            list.innerHTML = "<li style='color:#ccc; text-align:center; padding:10px;'>æ­¤æ¢ä»¶ä¸‹ç„¡ç´€éŒ„</li>";
            return;
        }

        displayData.forEach(row => {
            const color = row.æ”¶æ”¯ === "æ”¶å…¥" ? "#4caf50" : "#e91e63"; 
            const sign = row.æ”¶æ”¯ === "æ”¶å…¥" ? "+" : "-";
            
            // ç”¢ç”Ÿåˆªé™¤æ‰€éœ€çš„åƒæ•¸
            let dateStr = formatDate(row.æ—¥æœŸ); 
            
            list.innerHTML += `
                <li style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                    <div style="flex:1;">
                        <span style="font-weight:bold; color:#555;">${row.é …ç›®}</span>
                        <span style="font-size:0.85em; color:#999; margin-left:5px;">(${dateStr})</span>
                        <br>
                        <span style="font-size:0.85em; background:#f0f0f0; padding:2px 6px; border-radius:4px;">${row.é¡åˆ¥}</span>
                        <span style="font-size:0.85em; background:#f0f0f0; padding:2px 6px; border-radius:4px;">${row.å¸³æˆ¶}</span>
                    </div>
                    <div style="font-weight:bold; color:${color}; margin-right:10px;">${sign}$${Number(row.é‡‘é¡).toLocaleString()}</div>
                    
                    <button onclick="deleteExpense('${dateStr}', '${row.é …ç›®}', '${row.é‡‘é¡}', this)" style="background:#ffebee; color:#c62828; padding:5px 10px; font-size:0.8rem; border-radius:5px; box-shadow:none; border:1px solid #ffcdd2;">
                        ğŸ—‘ï¸
                    </button>
                </li>`;
        });
    }

    // --- åŠŸèƒ½ 7ï¼šæ”¯å‡ºæ¯”è¼ƒ ---
    function loadExpenseComparison() {
        fetch(API_URL + "?tab=Expenses_DB").then(res => res.json()).then(data => {
            if(data.length === 0) return;
            const now = new Date(); 
            const cmKey = `${now.getFullYear()}/${now.getMonth() + 1}`;
            let lmYear = now.getFullYear(), lmMonth = now.getMonth(); 
            if (lmMonth === 0) { lmYear -= 1; lmMonth = 12; } 
            const lmKey = `${lmYear}/${lmMonth}`;
            
            const cats = ['é£Ÿ', 'è¡£', 'ä½', 'è¡Œ', 'è‚²æ¨‚', 'å…¶ä»–'];
            let stats = { tm: { 'é£Ÿ':0, 'è¡£':0, 'ä½':0, 'è¡Œ':0, 'è‚²æ¨‚':0, 'å…¶ä»–':0, 'total': 0 }, lm: { 'é£Ÿ':0, 'è¡£':0, 'ä½':0, 'è¡Œ':0, 'è‚²æ¨‚':0, 'å…¶ä»–':0, 'total': 0 } };
            
            data.forEach(row => {
                if (row.æ”¶æ”¯ !== "æ”¯å‡º") return; 
                let d = new Date(row.æ—¥æœŸ); 
                let rKey = !isNaN(d.getTime()) ? `${d.getFullYear()}/${d.getMonth()+1}` : "";
                
                if(typeof row.æ—¥æœŸ === 'string' && row.æ—¥æœŸ.includes("/")) { 
                    let parts = row.æ—¥æœŸ.split("/"); 
                    let y = parts.length===3 ? parts[0] : now.getFullYear(); 
                    let m = parts.length===3 ? parts[1] : parts[0]; 
                    rKey = `${y}/${parseInt(m)}`; 
                }

                let c = cats.includes(row.é¡åˆ¥) ? row.é¡åˆ¥ : "å…¶ä»–"; 
                let amt = Number(row.é‡‘é¡);
                if (rKey === cmKey) { stats.tm[c]+=amt; stats.tm.total+=amt; } 
                else if (rKey === lmKey) { stats.lm[c]+=amt; stats.lm.total+=amt; }
            });

            document.getElementById('monthExpenseDisplay').innerText = "$" + stats.tm.total.toLocaleString();
            
            // é ç®—æ›´æ–°
            const currentExpense = stats.tm.total; 
            const remain = MONTHLY_BUDGET - currentExpense; 
            let percent = Math.round((currentExpense / MONTHLY_BUDGET) * 100); 
            let barWidth = percent > 100 ? 100 : percent;

            document.getElementById('budgetLimit').innerText = MONTHLY_BUDGET.toLocaleString(); 
            document.getElementById('budgetPercent').innerText = percent + "%"; 
            document.getElementById('budgetBar').style.width = barWidth + "%";
            
            const msgEl = document.getElementById('budgetMessage'); 
            if (remain >= 0) { 
                msgEl.innerText = `âœ… é‚„å‰© $${remain.toLocaleString()} å¯èŠ±`; 
                document.getElementById('budgetBar').style.backgroundColor = "#fff"; 
            } else { 
                msgEl.innerText = `âš ï¸ å·²è¶…æ”¯ $${Math.abs(remain).toLocaleString()} !`; 
                document.getElementById('budgetBar').style.backgroundColor = "#ffeb3b"; 
            }

            document.getElementById('lastMonthTotalDisplay').innerText = "$" + stats.lm.total.toLocaleString();
            let diff = stats.tm.total - stats.lm.total;
            document.getElementById('totalDiff').innerHTML = diff > 0 ? `<span style="color:red">å¤šèŠ± $${diff.toLocaleString()}</span>` : `<span style="color:green">çœä¸‹ $${Math.abs(diff).toLocaleString()}</span>`;

            const ctx = document.getElementById('expenseCompareChart'); 
            if(compareChart) compareChart.destroy();
            compareChart = new Chart(ctx, { 
                type: 'bar', 
                data: { labels: cats, datasets: [{ label: 'æœ¬æœˆ', data: cats.map(c=>stats.tm[c]), backgroundColor: '#36a2eb' }, { label: 'ä¸Šæœˆ', data: cats.map(c=>stats.lm[c]), backgroundColor: '#ff6384' }] }, 
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } 
            });

            const body = document.getElementById('compareTableBody'); body.innerHTML = "";
            cats.forEach(c => { 
                let v1 = stats.tm[c], v2 = stats.lm[c], d = v1-v2; 
                let dStr = d > 0 ? `<span style="color:red">â–² ${d}</span>` : (d<0 ? `<span style="color:green">â–¼ ${Math.abs(d)}</span>` : "-"); 
                body.innerHTML += `<tr><td style="padding:8px;font-weight:bold">${c}</td><td>$${v1}</td><td style="color:#888">$${v2}</td><td>${dStr}</td></tr>`; 
            });
        });
    }

    // --- åŠŸèƒ½ 8 (é¡¯ç¤ºç‰ˆ)ï¼šæ¯æœˆæ”¶å…¥ä¾†æºåˆ†æ ---

    function loadMonthlyIncome() {
        fetch(API_URL + "?tab=Asset_Log")
            .then(res => res.json())
            .then(data => {
                if(data.length === 0) return;

                let monthlyData = {}; 

                data.forEach(row => {
                    let amount = Number(row.é‡‘é¡);
                    if (amount <= 0) return; 

                    let account = row.å¸³æˆ¶ || "";
                    let category = row.è³‡ç”¢é¡åˆ¥ || row.é¡åˆ¥ || "";
                    if (!account.includes("éƒµå±€") && !account.includes("éŠ€è¡Œ") && !account.includes("ç¾é‡‘") && category !== "ç¾é‡‘") return;

                    let dateStr = row.æ—¥æœŸ;
                    let monthKey = "";
                    try {
                        let dateObj = new Date(dateStr);
                        let y = dateObj.getFullYear();
                        let m = String(dateObj.getMonth() + 1).padStart(2, '0');
                        if (isNaN(y)) return;
                        monthKey = `${y}/${m}`;
                    } catch (e) { return; }

                    if (!monthlyData[monthKey]) monthlyData[monthKey] = { salary: 0, invest: 0 };

                    let item = row.é …ç›®åç¨± || row.é …ç›® || "";
                    
                    if (item.includes("è³£å‡º") || item.includes("å­˜éŒ¢") || item.includes("è½‰å…¥") || item.includes("é ˜éŒ¢") || item.includes("æ›åŒ¯")) return; 

                    if (item.includes("è‚¡åˆ©") || item.includes("åˆ©æ¯") || item.includes("è‚¡æ¯")) {
                        monthlyData[monthKey].invest += amount;
                    } else if (item.includes("è–ª") || item.includes("å·¥è®€") || item.includes("çé‡‘") || item.includes("ç›£è€ƒ") || item.includes("æ™®ç™¼") || item.includes("å®¶æ•™") || item.includes("åŠ©æ•™") || item.includes("æ‰“å·¥")) {
                        monthlyData[monthKey].salary += amount;
                    }
                });

                let sortedMonths = Object.keys(monthlyData).sort();
                let salaryArr = sortedMonths.map(m => monthlyData[m].salary);
                let investArr = sortedMonths.map(m => monthlyData[m].invest);

                const ctx = document.getElementById('incomeSourceChart');
                if (incomeChart) incomeChart.destroy();

                incomeChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sortedMonths,
                        datasets: [
                            { label: 'è–ªè³‡/ä¸»å‹•æ”¶å…¥', data: salaryArr, backgroundColor: '#36A2EB', stack: 'Stack 0' },
                            { label: 'æŠ•è³‡/è¢«å‹•æ”¶å…¥', data: investArr, backgroundColor: '#FFCE56', stack: 'Stack 0' }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        // ğŸŸ¢ é—œéµä¿®æ”¹ 1ï¼šäº’å‹•æ¨¡å¼
                        interaction: {
                            mode: 'index',      // åªè¦æ»‘é¼ åœ¨è©²æœˆä»½çš„ X è»¸ä¸Šï¼Œå°±é¡¯ç¤ºæ‰€æœ‰æ•¸æ“š
                            intersect: false,   // ä¸ç”¨ç²¾æº–æŒ‡åˆ°è‰²å¡Šä¹Ÿèƒ½è§¸ç™¼
                        },
                        // ğŸŸ¢ é—œéµä¿®æ”¹ 2ï¼šå„ªåŒ–æç¤ºæ¡† (åŠ ä¸Š $ ç¬¦è™Ÿå’Œåƒåˆ†ä½)
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            // è®Šæˆ $12,345 æ ¼å¼
                                            label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }
                    }
                });
            });
    }


    // --- åŠŸèƒ½ 9 (ä¿®æ­£ç‰ˆ)ï¼šè¨ˆç®—é¤˜é¡ + è§¸ç™¼é¡˜æœ›æ¸…å–® ---
    function loadAccountBalances() {
        Promise.all([
            fetch(API_URL+"?tab=Asset_Log").then(r=>r.json()), 
            fetch(API_URL+"?tab=Expenses_DB").then(r=>r.json())
        ]).then(([aData, eData]) => {
            
            let bal = {};
            // 1. ç®—è³‡ç”¢æµå‹•
            aData.forEach(r => { let a=r.å¸³æˆ¶; if(a) bal[a] = (bal[a]||0) + Number(r.é‡‘é¡); });
            // 2. ç®—æ—¥å¸¸æ”¯å‡º
            eData.forEach(r => { let a=r.å¸³æˆ¶, amt=Number(r.é‡‘é¡); if(a) { if(r.æ”¶æ”¯==="æ”¯å‡º") bal[a] = (bal[a]||0) - amt; else bal[a] = (bal[a]||0) + amt; } });

            // 3. è¨ˆç®—ç”Ÿæ´»å¯ç”¨è³‡é‡‘
            const livingAcc = ["éŒ¢åŒ…", "ä¸­åœ‹ä¿¡è¨—", "icash", "ipassmoney", "å­¸ç”Ÿè­‰", "æ‚ éŠå¡", "ä¸€å¡é€š"];
            let liveTotal = 0; 
            livingAcc.forEach(a => liveTotal += (bal[a]||0));
            
            // ğŸŸ¢ é—œéµä¿®æ”¹ï¼šå­˜å…¥å…¨åŸŸè®Šæ•¸
            globalLivingFunds = liveTotal;

            // æ›´æ–°ç¶²é é¡¯ç¤º (å¦‚æœæœ‰é‡è¤‡IDï¼Œé€™è£¡åªæœƒæ›´æ–°ç¬¬ä¸€å€‹ï¼Œå»ºè­°ç”¨ Class ä½†é€™è£¡å…ˆç¶­æŒ ID)
            const displayEl = document.getElementById('livingFundsDisplay');
            if(displayEl) displayEl.innerText = "$" + liveTotal.toLocaleString();

            // ğŸŸ¢ é—œéµä¿®æ”¹ï¼šé¤˜é¡ç®—å¥½äº†ï¼Œç¾åœ¨å¯ä»¥è¼‰å…¥é¡˜æœ›æ¸…å–®äº†ï¼
            loadWishlist();

            // 4. æ›´æ–°å€‹åˆ¥å¸³æˆ¶å¡ç‰‡
            const box = document.getElementById('accountBalanceContainer'); 
            if(box) {
                box.innerHTML = "";
                const sortList = [...livingAcc, "éƒµå±€", "å¯Œé‚¦éŠ€è¡Œ", "å¯Œé‚¦è­‰åˆ¸", "å¾…ä»˜æ¬¾"];
                Object.keys(bal).sort((a,b) => (sortList.indexOf(a)===-1?99:sortList.indexOf(a)) - (sortList.indexOf(b)===-1?99:sortList.indexOf(b))).forEach(a => { let v = bal[a], c = v>=0?"#333":"#e91e63"; box.innerHTML += `<div style="background:#f8f9fa;padding:15px;border-radius:8px;text-align:center;border:1px solid #eee;"><div style="font-size:0.9em;color:#666;margin-bottom:5px;">${a}</div><div style="font-size:1.2em;font-weight:bold;color:${c}">$${v.toLocaleString()}</div></div>`; });
            }
        });
    }

    // --- åŠŸèƒ½ 10ï¼šè½‰å¸³ ---
    function submitTransfer() {
        const btn = document.getElementById('btnTrans');
        const vals = { date: document.getElementById('transDate').value, from: document.getElementById('transFrom').value, to: document.getElementById('transTo').value, amt: document.getElementById('transAmount').value };
        if(!vals.amt || vals.from === vals.to) { alert("é‡‘é¡éŒ¯èª¤"); return; }
        btn.innerText = "è™•ç†ä¸­..."; btn.disabled = true;
        const pOut = { tab:"Asset_Log", date:vals.date, account:vals.from, category:"ç¾é‡‘", item:"è½‰å‡º->"+vals.to, qty:"", amount:-Math.abs(vals.amt), type:"æµå‡º" };
        const pIn = { tab:"Asset_Log", date:vals.date, account:vals.to, category:"ç¾é‡‘", item:"è½‰å…¥<-"+vals.from, qty:"", amount:Math.abs(vals.amt), type:"æµå…¥" };
        Promise.all([fetch(API_URL, { method:'POST', body:JSON.stringify(pOut) }), fetch(API_URL, { method:'POST', body:JSON.stringify(pIn) })]).then(() => { alert("è½‰å¸³æˆåŠŸï¼"); btn.innerText="ç¢ºèª"; btn.disabled=false; document.getElementById('transAmount').value=""; loadAssetChart(); loadAccountBalances(); });
    }

    // --- åŠŸèƒ½ 11ï¼šè³‡ç”¢è¶¨å‹¢åœ– ---
    function loadTrendChart() {
        Promise.all([fetch(API_URL+"?tab=History_Log").then(r=>r.json())]).then(([histData]) => {
            if(histData.length === 0) return;
            let groupedData = {}, allDates = new Set(), totalAssetRecords = [];
            histData.forEach(r => {
                let dStr = r.æ—¥æœŸ; if(!dStr) return;
                let dObj = new Date(dStr), dateKey = "", ts = 0;
                if(!isNaN(dObj.getTime())) { dateKey = dStr; ts = dObj.getTime(); } 
                else if (typeof dStr === 'string') { dateKey = dStr; let parts = dStr.split(/[-/]/); if(parts.length >= 3) ts = new Date(parts[0], parts[1]-1, parts[2]).getTime(); }
                if(!dateKey) return;
                allDates.add(dateKey); let item = r.è³‡ç”¢åç¨±, val = Number(r.ç¾æ·¨å€¼);
                if(!groupedData[item]) groupedData[item] = {}; groupedData[item][dateKey] = val;
                if (item === "ç¸½è³‡ç”¢" && val > 0) totalAssetRecords.push({ ts: ts, val: val, dateStr: dateKey });
            });

            totalAssetRecords.sort((a, b) => a.ts - b.ts);
            const predEl = document.getElementById('predictionText');
            if (predEl && totalAssetRecords.length >= 2) {
                let first = totalAssetRecords[0], last = totalAssetRecords[totalAssetRecords.length - 1];
                let daysDiff = (last.ts - first.ts) / (1000 * 60 * 60 * 24), moneyDiff = last.val - first.val;
                if (daysDiff > 14) {
                    let growthSpeed = moneyDiff / (daysDiff / 30), remaining = SAVING_GOAL - last.val;
                    if (remaining > 0 && growthSpeed > 0) {
                        let monthsNeeded = remaining / growthSpeed;
                        let targetDate = new Date(); targetDate.setMonth(targetDate.getMonth() + Math.ceil(monthsNeeded));
                        let targetDateStr = `${targetDate.getFullYear()}å¹´ ${targetDate.getMonth() + 1}æœˆ`;
                        predEl.innerHTML = `ğŸš€ å¹³å‡æœˆå¢ <b style="color:#2E86C1">$${Math.round(growthSpeed).toLocaleString()}</b>ï¼Œé è¨ˆ <b style="color:#27AE60">${targetDateStr}</b> é”æ¨™ï¼`;
                    } else if (remaining <= 0) predEl.innerHTML = `ğŸ‰ æ­å–œï¼ä½ å·²ç¶“é”æˆç›®æ¨™äº†ï¼`;
                    else predEl.innerHTML = `ğŸ“‰ è³‡ç”¢æš«æ™‚ç¸®æ°´ï¼ŒåŠ æ²¹ï¼`;
                } else predEl.innerText = "â³ æ•¸æ“šç´¯ç©ä¸­...";
            }

            let sortedDates = Array.from(allDates).sort((a, b) => new Date(a) - new Date(b));
            let datasets = [], colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF'], colorIdx = 0;
            if(groupedData["ç¸½è³‡ç”¢"]) { datasets.push({ label: "ç¸½è³‡ç”¢", data: sortedDates.map(d => groupedData["ç¸½è³‡ç”¢"][d] || null), borderColor: "#333", borderWidth: 3, tension: 0.1, pointRadius: 4, yAxisID: 'y' }); delete groupedData["ç¸½è³‡ç”¢"]; }
            for(let item in groupedData) { datasets.push({ label: item, data: sortedDates.map(d => groupedData[item][d] || null), borderColor: colors[colorIdx % colors.length], backgroundColor: colors[colorIdx % colors.length], borderWidth: 2, tension: 0.1, pointRadius: 3, yAxisID: 'y' }); colorIdx++; }
            
            const ctx = document.getElementById('trendChart'); if(trendChart) trendChart.destroy();
            trendChart = new Chart(ctx, { type: 'line', data: { labels: sortedDates, datasets: datasets }, options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, scales: { y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'å¸‚å€¼ (TWD)' } } }, plugins: { legend: { position: 'bottom' } } } });
        });
    }

    // --- åŠŸèƒ½ 12ï¼šæ‰¹æ¬¡å¯«å…¥å¿«ç…§ ---
    function snapshotAssets() {
        if(!globalSnapshotData || globalSnapshotData.length === 0) { alert("æ•¸æ“šè¼‰å…¥ä¸­..."); return; }
        const btn = document.getElementById('btnSnapshot'); btn.innerText = "å„²å­˜ä¸­..."; btn.disabled = true;
        const today = new Date().toISOString().split('T')[0];
        let rowsToSend = globalSnapshotData.map(item => {
            let finalName = item.item;
            if (String(finalName).startsWith("0") && !isNaN(finalName)) { finalName = "'" + finalName; }
            return [today, finalName, item.qty, item.mv, item.cost];
        });
        const payload = { tab: "History_Log", rows: rowsToSend };
        fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) }).then(res => res.text()).then(data => { if(data.includes("Success")) { alert("ğŸ“¸ æˆåŠŸç´€éŒ„ï¼"); btn.innerText = "ğŸ“¸ ç´€éŒ„å¿«ç…§"; btn.disabled = false; loadTrendChart(); } else { alert("å¤±æ•—ï¼š" + data); btn.disabled = false; } });
    }

    // --- åŠŸèƒ½ 13 ~ 15ï¼šåª’é«”æ«ƒ ---
    function toggleMediaForm() { const f = document.getElementById('mediaForm'); f.style.display = f.style.display==="none"?"flex":"none"; }
    function submitMedia() {
        const btn = event.target; btn.innerText = "..."; btn.disabled = true;
        const payload = { tab: "Media_Log", date: document.getElementById('mediaDate').value, type: document.getElementById('mediaType').value, title: document.getElementById('mediaTitle').value, rating: document.getElementById('mediaRating').value, comment: document.getElementById('mediaComment').value };
        if(!payload.title) { alert("è«‹å¡«æ¨™é¡Œ"); btn.disabled=false; return; }
        fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) }).then(r=>r.text()).then(d=>{ if(d.includes("Success")) { alert("æˆåŠŸï¼"); btn.innerText="å„²å­˜"; btn.disabled=false; toggleMediaForm(); loadMediaList(); } else { alert("å¤±æ•—"); btn.disabled=false; } });
    }
    function loadMediaList() {
        fetch(API_URL + "?tab=Media_Log").then(r=>r.json()).then(data => {
            const c = document.getElementById('mediaContainer'); c.innerHTML = "";
            if(data.length===0) { c.innerHTML="<div style='color:#ccc'>ç„¡ç´€éŒ„</div>"; return; }
            data.reverse().forEach(row => {
                let stars = "â­".repeat(Number(row.è©•åˆ†)), icon = row.é¡åˆ¥==="æ›¸ç±"?"ğŸ“–":"ğŸ¬";
                c.innerHTML += `<div style="background:#f8f9fa;padding:15px;border-radius:10px;border-left:4px solid #607d8b;box-shadow:0 2px 5px rgba(0,0,0,0.05);"><div style="display:flex;justify-content:space-between;margin-bottom:5px;"><span style="font-size:0.85em;color:#666;">${icon} ${row.é¡åˆ¥}</span><span style="font-size:0.85em;color:#999;">${row.æ—¥æœŸ}</span></div><div style="font-weight:bold;margin-bottom:5px;">${row.æ¨™é¡Œ}</div><div style="color:#f39c12;margin-bottom:8px;">${stars}</div><div style="font-size:0.9em;color:#555;">"${row.å¿ƒå¾—}"</div></div>`;
            });
        });
    }

    // --- ğŸŸ¢ åŠŸèƒ½ 16 (æ™‚å€ä¿®æ­£ç‰ˆ)ï¼šå€’æ•¸æ—¥ (å¼·åˆ¶æœ¬åœ°æ™‚é–“ï¼Œè§£æ±ºéæœŸä¸æ¶ˆå¤±) ---
    function loadTimeWidget() {
        const container = document.getElementById('timeContainer');
        if(!container) return;
        
        // 1. è¨­å®šã€Œç¾åœ¨ã€ç‚ºä»Šæ—¥åˆå¤œ 00:00:00 (æœ¬åœ°æ™‚é–“)
        const now = new Date();
        now.setHours(0, 0, 0, 0);

        const currentYear = now.getFullYear();
        const startOfYear = new Date(currentYear, 0, 1);
        const endOfYear = new Date(currentYear + 1, 0, 1);
        const yearPercent = ((now - startOfYear) / (endOfYear - startOfYear)) * 100;
        
        let html = `
            <div>
                <div style="display:flex; justify-content:space-between; font-size:0.9em; margin-bottom:5px;">
                    <span>${currentYear}å¹´ å·²é</span>
                    <span>${yearPercent.toFixed(1)}%</span>
                </div>
                <div style="width:100%; background:rgba(255,255,255,0.2); border-radius:10px; height:8px;">
                    <div style="height:100%; background:#fff; width:${yearPercent}%; border-radius:10px; transition:width 1s;"></div>
                </div>
            </div>
        `;

        fetch(API_URL + "?tab=Events_DB")
            .then(res => res.json())
            .then(data => {
                if(data.length === 0) {
                    container.innerHTML = html + "<div style='text-align:center; font-size:0.8em; opacity:0.7; margin-top:10px;'>å°šç„¡å€’æ•¸äº‹ä»¶</div>";
                    return;
                }

                data.forEach(event => {
                    let evtTitle = event['äº‹ä»¶åç¨±'] || event['title']; 
                    let evtDate = event['æ—¥æœŸ'] || event['date'];
                    let rawType = event['é¡å‹'] || event['type'] || "fixed";
                    let evtType = String(rawType).toLowerCase().trim(); 

                    // ğŸŸ¢ é—œéµä¿®æ”¹ï¼šä¸ç›´æ¥ new Date(å­—ä¸²)ï¼Œè€Œæ˜¯æ‰‹å‹•æ‹†è§£å¹´æœˆæ—¥
                    // é€™æ¨£å¯ä»¥ç¢ºä¿å»ºç«‹çš„æ˜¯ã€Œæœ¬åœ°æ™‚é–“çš„ 00:00:00ã€ï¼Œå®Œå…¨ç„¡è¦–æ™‚å€å·®
                    let dateStr = String(evtDate).replace(/\//g, "-").split("T")[0]; // æ‹¿åˆ° "2025-12-15"
                    let parts = dateStr.split("-"); // æ‹†æˆ ["2025", "12", "15"]
                    
                    // å»ºæ§‹å­ï¼šnew Date(å¹´, æœˆ-1, æ—¥) -> é€™æœƒå»ºç«‹æœ¬åœ°æ™‚é–“
                    let targetDate = new Date(
                        parseInt(parts[0]), 
                        parseInt(parts[1]) - 1, 
                        parseInt(parts[2])
                    );

                    if (evtType === "yearly") {
                        // æ¯å¹´é‡è¤‡ï¼šå¼·åˆ¶æŠŠå¹´ä»½æ”¹æˆä»Šå¹´
                        targetDate.setFullYear(currentYear);
                        
                        // å¦‚æœä»Šå¹´çš„é€™å€‹æ—¥å­ã€Œå·²ç¶“éäº†ã€(æ˜¨å¤©ä»¥å‰)ï¼Œå°±è·³æ˜å¹´
                        if (targetDate < now) {
                            targetDate.setFullYear(currentYear + 1);
                        }
                    } 
                    // å¦‚æœæ˜¯ fixedï¼ŒtargetDate å·²ç¶“æ˜¯æ­£ç¢ºçš„æ—¥æœŸäº†ï¼Œä¸ç”¨å‹•

                    // è¨ˆç®—å¤©æ•¸å·®è·
                    // å› ç‚º now å’Œ targetDate éƒ½å·²ç¶“å¼·åˆ¶è¨­ç‚º 00:00:00ï¼Œç›´æ¥ç›¸æ¸›é™¤ä»¥ä¸€å¤©çš„æ¯«ç§’æ•¸ï¼Œæœƒå¾—åˆ°ç²¾æº–çš„æ•´æ•¸
                    const diffTime = targetDate - now;
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

                    // ğŸŸ¢ åˆ¤æ–·éæœŸ (å°æ–¼ 0 ä»£è¡¨æ˜¯æ˜¨å¤©ä»¥å‰) -> éš±è—
                    if (diffDays < 0 && evtType !== "yearly") return; 

                    let displayDate = formatDate(targetDate);
                    
                    let dayText = "";
                    let dayColor = "#ffeb3b"; 

                    if (diffDays === 0) {
                        dayText = "ğŸ‰ å°±æ˜¯ä»Šå¤©ï¼";
                        dayColor = "#4ade80"; 
                    } else if (diffDays > 0) {
                        dayText = `${diffDays} <span style="font-size:0.6em;">å¤©</span>`;
                    } else {
                        dayText = "å·²çµæŸ";
                        dayColor = "#ccc";
                    }

                    html += `
                        <div style="display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.1); padding:10px 15px; border-radius:10px;">
                            <div>
                                <div style="font-size:0.85em; opacity:0.8;">${evtTitle}</div>
                                <div style="font-size:1.1em; font-weight:bold;">${displayDate}</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:0.85em; opacity:0.8;">${diffDays === 0 ? "Status" : "é‚„å‰©ä¸‹"}</div>
                                <div style="font-size:1.5em; font-weight:bold; color:${dayColor};">
                                    ${dayText}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            })
            .catch(err => {
                console.error(err);
                container.innerHTML = html;
            });
    }

    // --- åŠŸèƒ½ 18 (å‡ç´šç‰ˆ)ï¼šå¤¢æƒ³è³¼ç‰©è»Š (å«åˆªé™¤ & è³¼è²·è‡ªå‹•åˆªé™¤) ---
    function loadWishlist() {
        // è®€å–å…¨åŸŸè®Šæ•¸ä¸­çš„è³‡é‡‘
        let currentCash = globalLivingFunds;

        fetch(API_URL + "?tab=Wishlist_DB").then(res => res.json()).then(data => {
            const container = document.getElementById('wishlistContainer');
            if(!container) return;
            container.innerHTML = "";
            
            if(data.length === 0) { container.innerHTML = "<div style='color:#ccc;text-align:center;'>ç›®å‰æ²’æœ‰é¡˜æœ›</div>"; return; }
            
            data.forEach((row, index) => {
                let itemName = row['é …ç›®åç¨±']||row['é …ç›®']||"";
                let price = Number(row['é ä¼°é‡‘é¡']||row['é‡‘é¡']||0);
                // ğŸŸ¢ å–å¾—æ—¥æœŸï¼Œå› ç‚ºå¾Œç«¯åˆªé™¤éœ€è¦æ¯”å°æ—¥æœŸ
                let dateStr = formatDate(row['æ—¥æœŸ']); 

                let diff = currentCash - price;
                let bg = diff >= 0 ? '#e8f5e9' : '#fff'; // è²·å¾—èµ·é¡¯ç¤ºæ·¡ç¶ åº•
                let status = diff >= 0 ? 
                    `<span style="color:#2e7d32;font-weight:bold;">âœ… å¯è³¼è²· (å‰© $${diff.toLocaleString()})</span>` : 
                    `<span style="color:#c62828;">âŒ å·® $${Math.abs(diff).toLocaleString()}</span>`;
                
                // ğŸŸ¢ ä¿®æ”¹è³¼è²·æŒ‰éˆ•ï¼šå¤šå‚³å…¥ dateStr
                let buyBtn = diff >= 0 ? 
                    `<button onclick="fillExpense('${dateStr}', '${itemName}', '${price}', this)" style="padding:5px 10px;font-size:0.8em;background:#4caf50;color:white;border:none;border-radius:5px;cursor:pointer;">è³¼è²·</button>` : 
                    ``;
                
                // ğŸŸ¢ æ–°å¢åˆªé™¤æŒ‰éˆ•
                let deleteBtn = `<button onclick="deleteWish('${dateStr}', '${itemName}', '${price}', this)" style="padding:5px 8px;font-size:0.8em;background:#ffebee;color:#c62828;border:1px solid #ffcdd2;border-radius:5px;margin-left:5px;cursor:pointer;">ğŸ—‘ï¸</button>`;

                container.innerHTML += `
                    <div id="wish-${index}" style="background:${bg};padding:12px;border-radius:8px;border:1px solid #eee;display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <div style="font-weight:bold;color:#333;">${itemName}</div>
                            <div style="font-size:0.9em;color:#666;">$${price.toLocaleString()}</div>
                            <div style="margin-top:2px;font-size:0.9em;">${status}</div>
                        </div>
                        <div style="display:flex; align-items:center;">
                            ${buyBtn}
                            ${deleteBtn}
                        </div>
                    </div>`;
            });
        });
    }

    // --- è¨±é¡˜è¡¨å–®åˆ‡æ› ---
    function toggleWishForm() { 
        const f = document.getElementById('wishForm'); 
        f.style.display = f.style.display === "none" ? "flex" : "none"; 
    }

    // --- é€å‡ºè¨±é¡˜ ---
    function submitWish() {
        const btn = event.target; btn.disabled = true;
        
        // ç°¡å–®é˜²å‘†
        const itemVal = document.getElementById('wishItem').value;
        const amtVal = document.getElementById('wishAmount').value;
        if(!itemVal || !amtVal) { alert("è«‹å¡«å¯«å®Œæ•´"); btn.disabled=false; return; }

        const vals = { 
            tab: "Wishlist_DB", 
            date: new Date().toISOString().split('T')[0], 
            item: itemVal, 
            amount: amtVal, 
            note: document.getElementById('wishNote').value 
        };

        fetch(API_URL, {method:'POST', body:JSON.stringify(vals)})
        .then(r=>r.text())
        .then(d=>{ 
            if(d.includes("Success")){
                alert("âœ¨ è¨±é¡˜æˆåŠŸï¼"); 
                // æ¸…ç©ºæ¬„ä½
                document.getElementById('wishItem').value="";
                document.getElementById('wishAmount').value="";
                document.getElementById('wishNote').value="";
                
                toggleWishForm(); 
                loadWishlist();
            } 
            btn.disabled = false; 
        });
    }

    // --- ğŸŸ¢ è³¼è²·ä¸¦è‡ªå‹•åˆªé™¤ ---
    function fillExpense(date, item, price, btnElement) {
        if(!confirm(`ğŸ‰ æ­å–œé”æˆé¡˜æœ›ï¼\n\nç³»çµ±å°‡æœƒï¼š\n1. æŠŠã€Œ${item}ã€å¸¶å…¥è¨˜å¸³é é¢\n2. å¾é¡˜æœ›æ¸…å–®ä¸­ç§»é™¤æ­¤é …ç›®\n\nç¢ºå®šå—ï¼Ÿ`)) return;

        // 1. å¡«å…¥è¨˜å¸³å€
        document.getElementById('expItem').value = item; 
        document.getElementById('expAmount').value = price; 
        document.getElementById('expType').value = "æ”¯å‡º";
        
        // 2. åˆ‡æ›é é¢
        switchTab('expenses'); 
        document.getElementById('expItem').scrollIntoView({behavior:"smooth"});
        
        // 3. è¦–è¦ºåˆªé™¤ (ç§»é™¤å¡ç‰‡)
        if(btnElement) { 
            let card = btnElement.closest('div[id^="wish-"]'); 
            if(card) { 
                card.style.transition = "opacity 0.5s";
                card.style.opacity = "0"; 
                setTimeout(()=>card.remove(), 500); 
            } 
        }
        
        // 4. å¾Œå°åˆªé™¤æŒ‡ä»¤
        const payload = {
            action: "delete",
            tab: "Wishlist_DB",
            date: date,
            item: item,
            amount: price
        };
        // éœé»˜ç™¼é€åˆªé™¤è«‹æ±‚
        fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });

        alert("å·²å¸¶å…¥è¨˜å¸³å€ï¼\nè©²é¡˜æœ›å·²å¾å¾Œå°æ¸…å–®ä¸­ç§»é™¤ã€‚");
    }

    // --- ğŸŸ¢ ç´”åˆªé™¤é¡˜æœ› ---
    function deleteWish(date, item, amount, btn) {
        if(!confirm(`ç¢ºå®šè¦æ”¾æ£„ã€Œ${item}ã€é€™å€‹é¡˜æœ›å—ï¼Ÿ`)) return;

        btn.innerText = "â³";
        btn.disabled = true;

        const payload = {
            action: "delete",
            tab: "Wishlist_DB",
            date: date,
            item: item,
            amount: amount
        };

        fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) })
        .then(res => res.text())
        .then(data => {
            if(data.includes("Deleted")) {
                let card = btn.closest('div[id^="wish-"]');
                card.style.opacity = "0";
                setTimeout(() => {
                    card.remove();
                    alert("ğŸ—‘ï¸ é¡˜æœ›å·²ç§»é™¤ï¼");
                }, 500);
            } else {
                alert("åˆªé™¤å¤±æ•—ï¼š" + data);
                btn.innerText = "ğŸ—‘ï¸";
                btn.disabled = false;
            }
        });
    }

    // --- ğŸŸ¢ åŠŸèƒ½ 20 (é™¤éŒ¯ç‰ˆ)ï¼šåˆªé™¤è¨˜å¸³ç´€éŒ„ ---
    function deleteExpense(date, item, amount, btn) {
        if(!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${item} $${amount}ã€é€™ç­†ç´€éŒ„å—ï¼Ÿ`)) return;

        btn.innerText = "â³";
        btn.disabled = true;

        const payload = {
            action: "delete",
            tab: "Expenses_DB",
            date: date,
            item: item,
            amount: amount
        };

        fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) })
        .then(res => res.text())
        .then(data => {
            if(data.includes("Deleted")) {
                let li = btn.closest('li');
                li.style.opacity = "0";
                setTimeout(() => {
                    li.remove();
                    loadExpenseComparison(); 
                    loadAccountBalances();
                    alert("ğŸ—‘ï¸ å·²åˆªé™¤ï¼");
                }, 500);
            } else if (data.includes("NotFound")) {
                // ğŸŸ¢ é€™è£¡æœƒæŠŠå¾Œç«¯å›å‚³çš„æ¯”è¼ƒè³‡æ–™å°å‡ºä¾†çµ¦ä½ çœ‹
                alert("âŒ åˆªé™¤å¤±æ•—ï¼ç³»çµ±æ‰¾ä¸åˆ°é€™ç­†è³‡æ–™ã€‚\n\nğŸ” å¾Œå°æ¯”å°çµæœï¼š\n" + data.replace("NotFound: ", ""));
                btn.innerText = "ğŸ—‘ï¸";
                btn.disabled = false;
            } else {
                alert("å¤±æ•—ï¼š" + data);
                btn.innerText = "ğŸ—‘ï¸";
                btn.disabled = false;
            }
        });
    }
</script>
</body>
</html>
