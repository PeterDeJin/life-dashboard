<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f4f7f6">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3135/3135715.png">
    
    <title>My Life Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        /* å…¨åŸŸè¨­å®šï¼šç¦æ­¢é¸å–æ–‡å­— (åƒ App è³ªæ„Ÿ) */
        body { 
            font-family: 'å¾®è»Ÿæ­£é»‘é«”', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            background: #f4f7f6; 
            padding: 15px; /* æ‰‹æ©Ÿç‰ˆé‚Šè·ç¸®å° */
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            -webkit-user-select: none; 
            user-select: none; 
            margin: 0; /* æ¸…é™¤é è¨­é‚Šè· */
        }

        .container { 
            max-width: 800px; 
            width: 100%; 
            padding-bottom: 80px; /* åº•éƒ¨ç•™ç™½çµ¦æ‰‹æŒ‡æ»‘å‹• */
        }
        
        .card { 
            background: white; 
            padding: 20px; 
            border-radius: 15px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); /* é™°å½±æŸ”å’Œä¸€é» */
            margin-bottom: 20px; 
            transition: transform 0.2s; /* é»æ“Šæ™‚çš„å°å‹•ç•« */
        }

        /* å€å¡Šé¡è‰²æ¨£å¼ */
        .check-in-box { background: linear-gradient(135deg, #e0f7fa 0%, #ffffff 100%); border: 2px solid #b2ebf2; }
        
        /* è¼¸å…¥æ¡†é€šç”¨æ¨£å¼ */
        .asset-form { display: flex; flex-direction: column; gap: 15px; }
        .asset-form label { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-weight: bold; 
            color: #555; 
            font-size: 0.95rem; /* æ‰‹æ©Ÿå­—é«”å¾®èª¿ */
        }
        
        /* è®“è¼¸å…¥æ¡†åœ¨æ‰‹æ©Ÿä¸Šæ›´å¥½é»æ“Š */
        .asset-form input, .asset-form select { 
            padding: 10px; 
            border-radius: 8px; 
            border: 1px solid #ddd; 
            width: 55%; 
            font-size: 16px; /* é˜²æ­¢ iPhone è‡ªå‹•æ”¾å¤§ */
            background: #f9f9f9;
        }

        /* æŒ‰éˆ•æ¨£å¼ï¼šæ›´åƒ App çš„æŒ‰éˆ• */
        button { 
            border: none; 
            padding: 12px 25px; 
            border-radius: 50px; 
            font-size: 1rem; 
            cursor: pointer; 
            transition: 0.2s; 
            color: white; 
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        button:active { transform: scale(0.96); }
        button:disabled { background: #ccc !important; box-shadow: none; }

        /* Checkbox å„ªåŒ– */
        .checkbox-group { display: flex; gap: 12px; margin: 15px 0; flex-wrap: wrap; }
        .checkbox-group label { 
            font-size: 1rem; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            background: rgba(255,255,255,0.6);
            padding: 5px 10px;
            border-radius: 20px;
        }
        .checkbox-group input { width: 22px; height: 22px; margin-right: 8px; }

        /* é€²åº¦æ¢ */
        .progress-container { width: 100%; background-color: rgba(255,255,255,0.3); border-radius: 10px; margin-top: 15px; height: 8px; overflow: hidden; }
        .progress-bar { height: 100%; background-color: #4ade80; width: 0%; transition: width 1s ease-in-out; }

        /* ========================================= */
        /* ğŸ“± é—œéµä¿®æ”¹ï¼šéŸ¿æ‡‰å¼ Grid æ’ç‰ˆ (Responsive) */
        /* ========================================= */
        
        /* é è¨­ (é›»è…¦ç‰ˆ)ï¼šç¶­æŒå…©æ¬„ */
        .grid-container {
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            width: 100%;
        }

        /* ğŸ“± æ‰‹æ©Ÿç‰ˆ (è¢å¹•å¯¬åº¦ < 768px)ï¼šå¼·åˆ¶è®Šå–®æ¬„ */
        @media (max-width: 768px) {
            .grid-container {
                grid-template-columns: 1fr !important; /* å¼·åˆ¶è®Šæˆä¸€æ¬„ */
            }
            
            /* æ‰‹æ©Ÿä¸Šçš„è¼¸å…¥æ¡†æ”¹ç‚ºä¸Šä¸‹æ’åˆ—ï¼Œæ¯”è¼ƒå¥½æŒ‰ */
            .asset-form label {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            .asset-form input, .asset-form select {
                width: 100%; /* å¯¬åº¦ä½”æ»¿ */
                box-sizing: border-box; /* é˜²æ­¢çˆ†ç‰ˆ */
            }

            /* éš±è—éƒ¨åˆ†ä¸é‡è¦çš„æ‰‹æ©Ÿè£é£¾ */
            h1 { font-size: 1.5rem; margin-bottom: 15px; }
            
            /* èª¿æ•´å¡ç‰‡å…§è· */
            .card { padding: 15px; }
            
            /* ç¸½è³‡ç”¢æ•¸å­—ç¸®å°ä¸€é»ä»¥å…æ›è¡Œ */
            #totalAssetsDisplay { font-size: 2.8rem !important; }
            
            /* ROI é‚£ä¸‰å€‹å°æ¡†æ¡†æ”¹ç‚ºç›´æ’æˆ–ç¸®å°é–“è· */
            .roi-box {
                flex-direction: row; 
                justify-content: space-around;
                gap: 10px !important;
            }
            .roi-item div:first-child { font-size: 0.8rem; } /* æ¨™é¡Œè®Šå° */
            .roi-item div:last-child { font-size: 1.1rem !important; } /* æ•¸å­—è®Šå° */
        }
    </style>
</head>
<body>

<div class="container">

    <div class="card full-width" style="background: linear-gradient(135deg, #2c3e50 0%, #4ca1af 100%); color: white; padding: 20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 style="margin:0; font-size: 1.1rem; opacity: 0.9;">â³ æ™‚é–“å€’æ•¸</h2>
            <button onclick="toggleEventForm()" style="background: rgba(255,255,255,0.2); font-size: 0.8rem; padding: 5px 10px; border:1px solid rgba(255,255,255,0.5);">ï¼‹ æ–°å¢</button>
        </div>

        <div id="eventForm" style="display:none; background:rgba(0,0,0,0.2); padding:15px; border-radius:10px; margin-bottom:15px; flex-direction:column; gap:10px;">
            <label style="font-size:0.9em;">äº‹ä»¶åç¨±</label>
            <input type="text" id="evtTitle" placeholder="ä¾‹å¦‚ï¼šç•¢æ¥­ã€å‡ºåœ‹" style="width:100%; padding:8px; border-radius:5px; border:none;">
            
            <label style="font-size:0.9em;">æ—¥æœŸ (YYYY-MM-DD æˆ– MM-DD)</label>
            <input type="text" id="evtDate" placeholder="2026-06-30 æˆ– 10-25" style="width:100%; padding:8px; border-radius:5px; border:none;">
            
            <label style="font-size:0.9em;">é¡å‹</label>
            <select id="evtType" style="width:100%; padding:8px; border-radius:5px; border:none;">
                <option value="fixed">ä¸€æ¬¡æ€§ (å›ºå®šå¹´ä»½)</option>
                <option value="yearly">æ¯å¹´é‡è¤‡ (ç”Ÿæ—¥/ç¯€æ…¶)</option>
            </select>
            
            <button onclick="submitEvent()" style="background: #4ca1af; color: white; margin-top:5px;">ç¢ºèªæ–°å¢</button>
        </div>
        
        <div id="timeContainer" style="display: flex; flex-direction: column; gap: 15px;">
            è¼‰å…¥ä¸­...
        </div>
    </div>

    <div class="grid-container">
        <div class="card" style="background: linear-gradient(135deg, #388e3c 0%, #81c784 100%); color: white; text-align: center; padding: 20px;">
            <h2 style="margin:0; font-size: 1.1rem; opacity: 0.9;">ğŸ’¸ ç”Ÿæ´»å¯ç”¨è³‡é‡‘</h2>
            <div id="livingFundsDisplay" style="font-size: 2.5rem; font-weight: bold; margin: 5px 0;">è¨ˆç®—ä¸­...</div>
            <div style="font-size: 0.85rem; opacity: 0.8;">(ä¸å«æŠ•è³‡å¸³æˆ¶)</div>
        </div>
        <div class="card" style="background: linear-gradient(135deg, #e53935 0%, #e57373 100%); color: white; text-align: center; padding: 20px;">
            <h2 style="margin:0; font-size: 1.1rem; opacity: 0.9;">ğŸ“‰ æœ¬æœˆç¸½æ”¯å‡º</h2>
            <div id="monthExpenseDisplay" style="font-size: 2.5rem; font-weight: bold; margin: 5px 0;">è¨ˆç®—ä¸­...</div>
            
            <div style="margin-top: 15px;">
                <div style="display:flex; justify-content:space-between; font-size:0.85em; opacity:0.9; margin-bottom:5px;">
                    <span>é ç®—: $<span id="budgetLimit">0</span></span>
                    <span id="budgetPercent">0%</span>
                </div>
                <div style="width:100%; background:rgba(255,255,255,0.3); border-radius:10px; height:8px; overflow:hidden;">
                    <div id="budgetBar" style="height:100%; background:#fff; width:0%; transition:width 1s ease-in-out;"></div>
                </div>
                <div id="budgetMessage" style="font-size:0.9em; margin-top:8px; font-weight:bold; text-align:right;">
                    è¨ˆç®—ä¸­...
                </div>
            </div>
        </div>
    </div>

    <div class="grid-container">
        <div class="card">
            <h2>ğŸ’¸ æ—¥å¸¸è¨˜å¸³</h2>
            <div class="asset-form">
                <label>æ—¥æœŸï¼š<input type="date" id="expDate"></label>
                <label>æ”¶æ”¯ï¼š
                    <select id="expType">
                        <option value="æ”¯å‡º">æ”¯å‡º (Expense)</option>
                        <option value="æ”¶å…¥">æ”¶å…¥ (Income)</option>
                    </select>
                </label>
                <label>å¸³æˆ¶ï¼š
                    <select id="expAccount">
                        <option value="éŒ¢åŒ…">ç¾é‡‘éŒ¢åŒ…</option>
                        <option value="ä¸­åœ‹ä¿¡è¨—">ä¸­åœ‹ä¿¡è¨—</option>
                        <option value="æ‚ éŠå¡">æ‚ éŠå¡</option>
                        <option value="icash">icash</option>
                        <option value="ipassmoney">iPass Money</option>
                        <option value="å­¸ç”Ÿè­‰">å­¸ç”Ÿè­‰</option>
                        <option value="ä¸€å¡é€š">ä¸€å¡é€š</option>
                        <option value="å¾…ä»˜æ¬¾">âš ï¸ å¾…ä»˜æ¬¾ (æ¬ åˆ¥äººçš„)</option>
                    </select>
                </label>
                <label>é¡åˆ¥ï¼š
                    <select id="expCategory">
                        <option value="é£Ÿ">é£Ÿ</option>
                        <option value="è¡£">è¡£</option>
                        <option value="ä½">ä½</option>
                        <option value="è¡Œ">è¡Œ</option>
                        <option value="è‚²æ¨‚">è‚²æ¨‚</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </label>
                <label>é …ç›®ï¼š<input type="text" id="expItem" placeholder="å¦‚: åˆé¤, ä»£å¢Š"></label>
                <label>é‡‘é¡ï¼š<input type="number" id="expAmount" placeholder="100"></label>
                <button onclick="submitExpense()" id="btnExp" style="margin-top: 10px; background: #e91e63;">è¨˜ä¸€ç­†</button>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“ æœ€è¿‘ 10 ç­†ç´€éŒ„</h2>
            <ul id="expenseList" style="list-style: none; padding: 0; max-height: 400px; overflow-y: auto;">
                <li style="color: #888;">è¼‰å…¥ä¸­...</li>
            </ul>
        </div>
    </div>

    <div class="card full-width">
        <h2>ğŸ“Š æœ¬æœˆ vs ä¸Šæœˆ æ”¯å‡ºæ¯”è¼ƒ</h2>
        <div class="grid-container">
            <div style="height: 300px;"><canvas id="expenseCompareChart"></canvas></div>
            <div>
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                    <thead>
                        <tr style="border-bottom: 2px solid #ddd; text-align: left;">
                            <th style="padding: 8px;">é¡åˆ¥</th>
                            <th style="padding: 8px; color: #36a2eb;">æœ¬æœˆ</th>
                            <th style="padding: 8px; color: #ff6384;">ä¸Šæœˆ</th>
                        </tr>
                    </thead>
                    <tbody id="compareTableBody"></tbody>
                </table>
                <div style="margin-top: 15px;">
                    <div style="padding: 8px; background: #fce4ec; border-radius: 5px; color: #c2185b; font-size: 0.9em; margin-bottom:5px;">
                        ğŸ“… ä¸Šæœˆç¸½æ”¯å‡ºï¼š<span id="lastMonthTotalDisplay" style="font-weight: bold;">...</span>
                    </div>
                    <div style="padding: 8px; background: #fff3cd; border-radius: 5px; color: #856404; font-size: 0.9em;">
                        ğŸ’¡ å·®ç•°ï¼š<span id="totalDiff" style="font-weight: bold;">...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card full-width" style="border-left: 5px solid #2196F3;">
        <h2>ğŸ’³ å„å¸³æˆ¶å³æ™‚é¤˜é¡ (å°å¸³å°ˆå€)</h2>
        <div id="accountBalanceContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px;">
            <div style="color: #888;">è¨ˆç®—ä¸­...</div>
        </div>
    </div>

    <div class="card full-width" style="border-left: 5px solid #9c27b0;">
        <h2>ğŸ”„ å…§éƒ¨è½‰å¸³ / é ˜éŒ¢ / é‚„å‚µ</h2>
        <div class="asset-form" style="flex-direction: row; flex-wrap: wrap; align-items: flex-end;">
            <div style="flex:1;">
                <label>æ—¥æœŸ</label><input type="date" id="transDate" style="width:90%">
            </div>
            <div style="flex:1;">
                <label>å¾</label>
                <select id="transFrom" style="width:90%">
                    <option value="éƒµå±€">éƒµå±€</option>
                    <option value="å¯Œé‚¦éŠ€è¡Œ">å¯Œé‚¦éŠ€è¡Œ</option>
                    <option value="ä¸­åœ‹ä¿¡è¨—">ä¸­åœ‹ä¿¡è¨—</option>
                    <option value="éŒ¢åŒ…">éŒ¢åŒ…</option>
                </select>
            </div>
            <div style="flex:0.2; text-align:center; padding-bottom:10px;">â¡ï¸</div>
            <div style="flex:1;">
                <label>è½‰å…¥</label>
                <select id="transTo" style="width:90%">
                    <option value="éŒ¢åŒ…">éŒ¢åŒ…</option>
                    <option value="ä¸­åœ‹ä¿¡è¨—">ä¸­åœ‹ä¿¡è¨—</option>
                    <option value="æ‚ éŠå¡">æ‚ éŠå¡</option>
                    <option value="ipassmoney">iPass Money</option>
                    <option value="icash">icash</option>
                    <option value="å¾…ä»˜æ¬¾">âš ï¸ å¾…ä»˜æ¬¾ (é‚„å‚µ)</option>
                    <option value="å¯Œé‚¦éŠ€è¡Œ">å¯Œé‚¦éŠ€è¡Œ</option>
                    <option value="å¯Œé‚¦è­‰åˆ¸">å¯Œé‚¦è­‰åˆ¸</option>
                </select>
            </div>
            <div style="flex:1;">
                <label>é‡‘é¡</label><input type="number" id="transAmount" style="width:90%" placeholder="1000">
            </div>
            <button onclick="submitTransfer()" id="btnTrans" style="background: #9c27b0; height: 38px; margin-bottom: 2px;">ç¢ºèª</button>
        </div>
    </div>

    <div class="card full-width" style="border-left: 5px solid #ff9800;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 style="margin:0; font-size: 1.1rem; opacity: 0.9;">ğŸ›ï¸ å¤¢æƒ³è³¼ç‰©è»Š</h2>
            <button onclick="toggleWishForm()" style="background: #ff9800; font-size: 0.8rem; padding: 5px 10px;">ï¼‹ è¨±é¡˜</button>
        </div>

        <div id="wishForm" class="asset-form" style="display:none; background:#fff3e0; padding:15px; border-radius:10px; margin-bottom:20px;">
            <label>é …ç›®ï¼š<input type="text" id="wishItem" placeholder="æƒ³è²·ä»€éº¼ï¼Ÿ"></label>
            <label>é‡‘é¡ï¼š<input type="number" id="wishAmount" placeholder="åƒ¹æ ¼"></label>
            <label>å‚™è¨»ï¼š<input type="text" id="wishNote" placeholder="ç¶²å€æˆ–å‚™è¨»"></label>
            <button onclick="submitWish()" style="background: #ff9800; color: white;">åŠ å…¥æ¸…å–®</button>
        </div>

        <div id="wishlistContainer" style="display: flex; flex-direction: column; gap: 10px;">
            <div style="color:#888;">è¼‰å…¥ä¸­...</div>
        </div>
    </div>

    <hr style="border: 0; border-top: 2px dashed #ddd; margin: 30px 0;">

    <h1>ğŸš€ è‡ªæˆ‘æˆé•·å„€è¡¨æ¿</h1>

    <div class="card check-in-box">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h2 style="margin:0; font-size: 1.2rem;">ğŸ“… ç¿’æ…£æ‰“å¡</h2>
            <input type="date" id="habitDate" style="border: 1px solid #b2ebf2; padding: 5px 10px; border-radius: 8px; background: rgba(255,255,255,0.8); font-weight: bold; color: #00796b;">
        </div>
        
        <div class="checkbox-group">
            <label><input type="checkbox" id="checkEnglish"> è‹±æ–‡</label>
            <label><input type="checkbox" id="checkExercise"> é‹å‹•ç¿’æ…£</label>
            <label><input type="checkbox" id="checkReading"> è®€æ›¸ç¿’æ…£</label>
            <label><input type="checkbox" id="checkSleeping"> ç¡è¦ºç¿’æ…£</label>
        </div>
        <button onclick="submitHabit()" id="submitBtn" style="background: #00897b;">é€å‡ºç´€éŒ„</button>
        <span id="statusMsg" style="margin-left: 10px; color: #666;"></span>
    </div>

    <div class="card">
        <h2>ğŸ“ˆ èƒ½åŠ›æˆé•·æ›²ç·š (æ¯æ—¥è¤‡åˆ©)</h2>
        <canvas id="habitChart"></canvas>
    </div>

    <hr style="border: 0; border-top: 2px dashed #ddd; margin: 30px 0;">

    <div class="card full-width" style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; text-align: center; padding: 30px;">
        <h2 style="margin:0; font-size: 1.2rem; opacity: 0.8;">ğŸ’° ç¸½è³‡ç”¢æ·¨å€¼ (å¸‚å€¼)</h2>
        <div id="totalAssetsDisplay" style="font-size: 3.5rem; font-weight: bold; margin: 10px 0;">è¨ˆç®—ä¸­...</div>
        
        <div style="margin-top: 20px; text-align: left;">
            <div style="display: flex; justify-content: space-between; font-size: 0.9em; opacity: 0.9; margin-bottom: 5px;">
                <span>ğŸ¯ ç¬¬ä¸€æ¡¶é‡‘ç›®æ¨™ï¼š$1,000,000</span>
                <span id="goalPercent">0%</span>
            </div>
            <div class="progress-container">
                <div id="goalProgressBar" class="progress-bar"></div>
            </div>
            <div id="predictionText" style="font-size: 0.85em; color: #666; margin-top: 8px; text-align: right;">
                æ­£åœ¨åˆ†æè³‡ç”¢æˆé•·é€Ÿåº¦...
            </div>
        </div>

        <div class="roi-box" style="display: flex; justify-content: center; gap: 30px; margin-top: 25px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px; flex-wrap: wrap;">
            <div class="roi-item" style="text-align: center;">
                <div style="font-size: 0.9rem; opacity: 0.8;">æŠ•è³‡ç¸½æˆæœ¬</div>
                <div id="totalCostDisplay" style="font-size: 1.2rem; font-weight: bold;">$0</div>
            </div>
            <div class="roi-item" style="text-align: center;">
                <div style="font-size: 0.9rem; opacity: 0.8;">æœªå¯¦ç¾æç›Š</div>
                <div id="totalProfitDisplay" style="font-size: 1.2rem; font-weight: bold;">$0</div>
            </div>
            <div class="roi-item" style="text-align: center;">
                <div style="font-size: 0.9rem; opacity: 0.8;">å ±é…¬ç‡ (ROI)</div>
                <div id="roiDisplay" style="font-size: 1.2rem; font-weight: bold; color: #4ade80;">0%</div>
            </div>
        </div>
    </div>

    <div class="card full-width">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2>ğŸ“ˆ å„è³‡ç”¢æ¯æœˆæˆé•·è¶¨å‹¢</h2>
            <button onclick="snapshotAssets()" id="btnSnapshot" style="background: #6c757d; font-size: 0.8rem; padding: 5px 15px;">ğŸ“¸ ç´€éŒ„æœ¬æœˆè©³ç´°å¿«ç…§</button>
        </div>
        <div style="height: 350px;">
            <canvas id="trendChart"></canvas>
        </div>
        <div style="font-size:0.8em; color:#666; margin-top:10px; text-align:center;">
            é»æ“Šä¸Šæ–¹åœ–ä¾‹å¯éš±è—/é¡¯ç¤ºç‰¹å®šè³‡ç”¢
        </div>
    </div>

    <div class="grid-container">
        <div class="card">
            <h2>ğŸ“Š è³‡ç”¢ç¾æ³é…ç½®</h2>
            <div style="height: 250px;"><canvas id="assetPieChart"></canvas></div>
        </div>
        <div class="card">
            <h2>ğŸ’µ æ¯æœˆæ”¶å…¥ (è–ªè³‡ vs æŠ•è³‡)</h2>
            <div style="height: 250px;"><canvas id="incomeSourceChart"></canvas></div>
        </div>
    </div>

    <div class="card full-width" style="border-left: 5px solid #fbc02d;">
        <h2>âœï¸ è³‡ç”¢äº¤æ˜“ç´€éŒ„ (è‚¡ç¥¨/å¤§é¡è³‡é‡‘)</h2>
        <div class="asset-form" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <label>æ—¥æœŸï¼š<input type="date" id="assetDate"></label>
            <label>å¸³æˆ¶ï¼š
                <select id="assetAccount">
                    <option value="éƒµå±€">éƒµå±€</option>
                    <option value="å¯Œé‚¦éŠ€è¡Œ">å¯Œé‚¦éŠ€è¡Œ</option>
                    <option value="å¯Œé‚¦è­‰åˆ¸">å¯Œé‚¦è­‰åˆ¸</option>
                </select>
            </label>
            <label>é¡åˆ¥ï¼š
                <select id="assetCategory">
                    <option value="ç¾é‡‘">ç¾é‡‘ (Cash)</option>
                    <option value="è‚¡ç¥¨">è‚¡ç¥¨ (Stock)</option>
                    <option value="åŠ å¯†è²¨å¹£">åŠ å¯†è²¨å¹£</option>
                </select>
            </label>
            <label>é …ç›®ï¼š<input type="text" id="assetItem" placeholder="å¦‚: 0050, è–ªæ°´"></label>
            <label>æ•¸é‡ï¼š<input type="number" id="assetQty" placeholder="è‚¡æ•¸/å…‹æ•¸"></label>
            <label>é‡‘é¡ï¼š<input type="number" id="assetAmount" placeholder="ç¸½åƒ¹"></label>
            <label>å‹æ…‹ï¼š
                <select id="assetType">
                    <option value="æµå…¥">æµå…¥/è²·å…¥ (+)</option>
                    <option value="æµå‡º">æµå‡º/è³£å‡º (-)</option>
                </select>
            </label>
        </div>
        <button onclick="submitAsset()" id="btnAsset" style="margin-top: 15px; background: #fbc02d; color: black; width: 100%;">æ–°å¢è³‡ç”¢ç´€éŒ„</button>
    </div>

    <hr style="border: 0; border-top: 2px dashed #ddd; margin: 30px 0;">

    <div class="card full-width" style="border-left: 5px solid #607d8b;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2>ğŸ“š çŸ¥è­˜è³‡ç”¢ (é–±è®€ & è§€å½±)</h2>
            <button onclick="toggleMediaForm()" style="background: #607d8b; font-size: 0.8rem; padding: 5px 15px;">ï¼‹ æ–°å¢ç´€éŒ„</button>
        </div>

        <div id="mediaForm" class="asset-form" style="display:none; background:#f0f4f8; padding:15px; border-radius:10px; margin-bottom:20px;">
            <label>æ—¥æœŸï¼š<input type="date" id="mediaDate"></label>
            <label>é¡åˆ¥ï¼š
                <select id="mediaType">
                    <option value="æ›¸ç±">æ›¸ç± (Book)</option>
                    <option value="é›»å½±">é›»å½± (Movie)</option>
                    <option value="èª²ç¨‹">èª²ç¨‹ (Course)</option>
                    <option value="å½±é›†">å½±é›† (Series)</option>
                </select>
            </label>
            <label>æ¨™é¡Œï¼š<input type="text" id="mediaTitle" placeholder="æ›¸å / ç‰‡å"></label>
            <label>è©•åˆ† (1-5)ï¼š
                <select id="mediaRating">
                    <option value="5">â­â­â­â­â­ (å¤§æ¨)</option>
                    <option value="4">â­â­â­â­ (ä¸éŒ¯)</option>
                    <option value="3">â­â­â­ (æ™®é€š)</option>
                    <option value="2">â­â­ (ä¸æ¨)</option>
                    <option value="1">â­ (é›·)</option>
                </select>
            </label>
            <label>ä¸€å¥å¿ƒå¾—ï¼š<input type="text" id="mediaComment" placeholder="å­¸åˆ°äº†ä»€éº¼ï¼Ÿ"></label>
            <button onclick="submitMedia()" style="background: #607d8b; color: white;">å„²å­˜åˆ°æ›¸æ«ƒ</button>
        </div>

        <div id="mediaContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
            <div style="color:#888;">è¼‰å…¥ä¸­...</div>
        </div>
    </div>

</div>

<script>
    // ==========================================
    // ğŸŸ¢ æ™ºæ…§ç™»å…¥ç³»çµ± 
    // ==========================================
    
    // 1. å˜—è©¦å¾ç€è¦½å™¨è¨˜æ†¶é«” (LocalStorage) æŠ“å–è¨­å®š
    let savedUrl = localStorage.getItem("MY_DASHBOARD_URL");
    let savedPass = localStorage.getItem("MY_DASHBOARD_PASS");

    // 2. å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨ (æ²’å­˜é)ï¼Œè·³å‡ºè©¢å•è¦–çª—
    if (!savedUrl || !savedPass) {
        alert("ğŸ‘‹ æ­¡è¿ï¼é€™æ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œè«‹é€²è¡Œåˆå§‹è¨­å®šã€‚");
        
        // å• GAS ç¶²å€ (é€™å°±æ˜¯ä½ çš„é‘°åŒ™)
        let inputUrl = prompt("è«‹è²¼ä¸Šæ‚¨çš„ GAS éƒ¨ç½²ç¶²å€ (script.google.com...):");
        if (inputUrl) {
            inputUrl = inputUrl.trim();
            localStorage.setItem("MY_DASHBOARD_URL", inputUrl); // å­˜èµ·ä¾†
            savedUrl = inputUrl;
        }

        // è¨­å®šä¸€çµ„å¯†ç¢¼
        let inputPass = prompt("è«‹è¨­å®šä¸€çµ„ç™»å…¥å¯†ç¢¼ (ä»¥å¾Œç”¨é€™çµ„è§£é–):");
        if (inputPass) {
            inputPass = inputPass.trim();
            localStorage.setItem("MY_DASHBOARD_PASS", inputPass); // å­˜èµ·ä¾†
            savedPass = inputPass;
        }
    }

    // 3. æª¢æŸ¥æ˜¯å¦è¨­å®šå®Œæˆ
    if (!savedUrl || !savedPass) {
        alert("âš ï¸ è¨­å®šæœªå®Œæˆï¼Œç„¡æ³•è¼‰å…¥ã€‚è«‹é‡æ–°æ•´ç†ç¶²é å†è©¦ä¸€æ¬¡ã€‚");
        throw new Error("Setup Incomplete");
    }

    // 4. æ¯æ—¥ç™»å…¥æª¢æŸ¥ (è¼¸å…¥å‰›å‰›è¨­å®šçš„å¯†ç¢¼)
    const inputCheck = prompt("ğŸ”’ è«‹è¼¸å…¥å¯†ç¢¼è§£é–è³‡ç”¢ç”Ÿæ´»ç´€éŒ„ç‰ˆï¼š");
    if (inputCheck !== savedPass) {
        document.body.innerHTML = `
            <div style='display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;text-align:center;'>
                <h1>â›”ï¸ å¯†ç¢¼éŒ¯èª¤</h1>
                <p>å­˜å–è¢«æ‹’çµ•ã€‚</p>
                <button onclick='localStorage.clear();location.reload();' style='padding:10px 20px;font-size:1rem;cursor:pointer;'>é‡è¨­æ‰€æœ‰è¨­å®š (å¿˜è¨˜å¯†ç¢¼é»æˆ‘)</button>
            </div>
        `;
        throw new Error("Access Denied");
    }

    // 5. è¨­å®šå…¨åŸŸè®Šæ•¸ (è®“å¾Œé¢çš„ç¨‹å¼ä½¿ç”¨)
    const API_URL = savedUrl;
    const SAVING_GOAL = 1000000; // ä½ çš„ç¬¬ä¸€æ¡¶é‡‘ç›®æ¨™
    const MONTHLY_BUDGET = 15000; // æ¯æœˆç¸½é ç®— (ä¾‹å¦‚ 25000)
    // ==========================================

    // ==========================================
    // ğŸŸ¢ æ–°å¢ï¼šåœ–è¡¨æ¨™ç±¤è¨­å®š (é è¨­å…¨é—œï¼Œåªåœ¨åœ“é¤…åœ–é–‹)
    // ==========================================
    Chart.register(ChartDataLabels);
    Chart.defaults.set('plugins.datalabels', { display: false }); 
    // ==========================================

    let myChart = null; let assetChart = null; let incomeChart = null; let compareChart = null; let trendChart = null;
    let globalSnapshotData = []; 
    let globalTotalAssets = 0; 

    // --- è¬ç”¨æ—¥æœŸæ ¼å¼åŒ–å‡½å¼ (YYYY/MM/DD) ---
    function formatDate(dateInput) {
        if (!dateInput) return "";
        try {
            let d = new Date(dateInput);
            
            // å¦‚æœè§£æå¤±æ•— (Invalid Date)ï¼Œå˜—è©¦æ‰‹å‹•è§£æ "YYYY/MM/DD" å­—ä¸²
            if (isNaN(d.getTime()) && typeof dateInput === 'string') {
                let parts = dateInput.split(/[-/]/);
                // è£œå…¨å¹´ä»½ (å¦‚æœåªæœ‰ MM/DD)
                let y = parts.length === 3 ? parts[0] : new Date().getFullYear();
                let m = parts.length === 3 ? parts[1] : parts[0];
                let day = parts.length === 3 ? parts[2] : parts[1];
                d = new Date(y, m - 1, day);
            }

            if (isNaN(d.getTime())) return dateInput; // çœŸçš„æ²’æ•‘äº†å°±å›å‚³åŸå­—ä¸²

            let yyyy = d.getFullYear();
            let mm = String(d.getMonth() + 1).padStart(2, '0');
            let dd = String(d.getDate()).padStart(2, '0');
            return `${yyyy}/${mm}/${dd}`;
        } catch (e) {
            return dateInput;
        }
    }

    window.onload = function() {
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0]; // æ ¼å¼ YYYY-MM-DD
        document.getElementById('habitDate').value = todayStr;
        
        loadChart();             
        loadAssetChart();        
        loadExpenses();          
        loadExpenseComparison(); 
        loadMonthlyIncome();     
        loadAccountBalances();
        loadTrendChart(); 
        loadMediaList();
        loadTimeWidget();
        loadWishlist();
    };

    // --- åŠŸèƒ½ 1 ï¼šç¿’æ…£æ‰“å¡ (æŠ“å–è¼¸å…¥æ¡†æ—¥æœŸ) ---
    function submitHabit() {
        const btn = document.getElementById('submitBtn');
        const msg = document.getElementById('statusMsg');
        
        // ğŸŸ¢ ä¿®æ”¹ 2ï¼šæŠ“å–ä½¿ç”¨è€…é¸çš„æ—¥æœŸ
        const dateVal = document.getElementById('habitDate').value;
        
        if (!dateVal) { alert("è«‹é¸æ“‡æ—¥æœŸ"); return; }

        btn.innerText = "å¯«å…¥ä¸­..."; 
        btn.disabled = true;

        const payload = {
            tab: "Habit_Log",
            date: dateVal, // ç›´æ¥å‚³é€è¼¸å…¥æ¡†çš„å€¼
            english: document.getElementById('checkEnglish').checked,
            exercise: document.getElementById('checkExercise').checked,
            reading: document.getElementById('checkReading').checked,
            sleeping: document.getElementById('checkSleeping').checked
        };

        fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) })
        .then(res => res.text()).then(data => {
            if(data.includes("Success")) {
                btn.innerText = "âœ… å®Œæˆ";
                msg.innerText = "ç´€éŒ„æˆåŠŸï¼";
                // æˆåŠŸå¾Œé‡æ–°æ•´ç†åœ–è¡¨
                setTimeout(() => { 
                    loadChart(); 
                    btn.disabled = false; 
                    btn.innerText = "é€å‡ºç´€éŒ„"; 
                    msg.innerText = ""; 
                }, 1500);
            } else { 
                alert("å¤±æ•—ï¼š" + data); 
                btn.disabled = false; 
                btn.innerText = "é€å‡ºç´€éŒ„";
            }
        });
    }

    // --- åŠŸèƒ½ 2 ï¼šç¿’æ…£åœ– ---
    function loadChart() {
        fetch(API_URL + "?tab=Habit_Log")
            .then(res => res.json())
            .then(data => {
                if(data.length === 0) return;
                
                // 1. å–å¾—æœ€è¿‘ 30 å¤©è³‡æ–™
                const recentData = data.slice(-30); 
                const dates = recentData.map(d => d.æ—¥æœŸ);

                // 2. æ ¸å¿ƒè¨ˆç®—å‡½å¼ï¼šæ¥æ”¶ä¸€å€‹ã€Œæ¬„ä½åç¨±ã€ï¼Œå›å‚³è©²ç¿’æ…£çš„ã€Œåˆ†æ•¸é™£åˆ—ã€
                function getHabitTrend(columnName) {
                    let score = 100; // âš ï¸ é‡é»ï¼šæ¯æ¬¡å‘¼å«é€™å€‹å‡½å¼ï¼Œåˆ†æ•¸éƒ½è¦é‡ç½®å› 100
                    
                    return recentData.map(d => {
                        // æŠ“å–å°æ‡‰æ¬„ä½çš„å€¼ (ä¾‹å¦‚ d['è‹±æ–‡'] æˆ– d['é‹å‹•ç¿’æ…£'])
                        let val = d[columnName];
                        
                        // åš´æ ¼åˆ¤æ–·ï¼šä¸ç®¡æ˜¯å¸ƒæ—å€¼ true é‚„æ˜¯å­—ä¸² "TRUE" éƒ½ç®—æˆåŠŸ
                        let isSuccess = (val === true || val === "TRUE" || val === "True");
                        
                        // è¤‡åˆ©è¨ˆç®—ï¼šæˆåŠŸ x1.01ï¼Œå¤±æ•— x0.99
                        if (isSuccess) {
                            score *= 1.01;
                        } else {
                            score *= 0.99;
                        }
                        
                        return score.toFixed(2);
                    });
                }

                // 3. ç¹ªè£½åœ–è¡¨
                const ctx = document.getElementById('habitChart');
                if(myChart) myChart.destroy();

                myChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [
                            { 
                                label: 'è‹±æ–‡', 
                                data: getHabitTrend('è‹±æ–‡'), // ğŸ‘ˆ æŒ‡å®šè®€å– Excel çš„ã€Œè‹±æ–‡ã€æ¬„ä½
                                borderColor: '#FF6384', 
                                tension: 0.3 
                            },
                            { 
                                label: 'é‹å‹•ç¿’æ…£', 
                                data: getHabitTrend('é‹å‹•ç¿’æ…£'), // ğŸ‘ˆ æŒ‡å®šè®€å–ã€Œé‹å‹•ç¿’æ…£ã€
                                borderColor: '#36A2EB', 
                                tension: 0.3 
                            },
                            { 
                                label: 'è®€æ›¸ç¿’æ…£', 
                                data: getHabitTrend('è®€æ›¸ç¿’æ…£'), // ğŸ‘ˆ æŒ‡å®šè®€å–ã€Œè®€æ›¸ç¿’æ…£ã€
                                borderColor: '#4BC0C0', 
                                tension: 0.3 
                            },
                            { 
                                label: 'ç¡è¦ºç¿’æ…£', 
                                data: getHabitTrend('ç¡è¦ºç¿’æ…£'), // ğŸ‘ˆ æŒ‡å®šè®€å–ã€Œç¡è¦ºç¿’æ…£ã€
                                borderColor: '#9966FF', 
                                tension: 0.3 
                            }
                        ]
                    },
                    options: { 
                        scales: { y: { suggestedMin: 90 } },
                        plugins: {
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        }
                    }
                });
            });
    }

    // --- åŠŸèƒ½ 3ï¼šè³‡ç”¢äº¤æ˜“ ---
    function submitAsset() {
        const btn = document.getElementById('btnAsset');
        const vals = {
            tab: "Asset_Log", date: document.getElementById('assetDate').value || new Date().toISOString().split('T')[0],
            account: document.getElementById('assetAccount').value, category: document.getElementById('assetCategory').value,
            item: document.getElementById('assetItem').value, qty: document.getElementById('assetQty').value,
            amount: document.getElementById('assetAmount').value, type: document.getElementById('assetType').value
        };
        if(!vals.item || !vals.amount) { alert("è«‹è¼¸å…¥é …ç›®å’Œé‡‘é¡"); return; }
        btn.innerText = "å¯«å…¥ä¸­..."; btn.disabled = true;
        if (vals.type.includes("æµå‡º")) vals.amount = -Math.abs(vals.amount); else vals.amount = Math.abs(vals.amount);
        fetch(API_URL, { method: 'POST', body: JSON.stringify(vals) }).then(res => res.text()).then(data => {
            if (data.includes("Success")) { alert("ğŸ’° è³‡ç”¢ç´€éŒ„æˆåŠŸï¼"); btn.innerText = "æ–°å¢è³‡ç”¢ç´€éŒ„"; btn.disabled = false; document.getElementById('assetItem').value = ""; document.getElementById('assetAmount').value = ""; loadAssetChart(); loadMonthlyIncome(); loadAccountBalances(); } 
            else { alert("å¤±æ•—ï¼š" + data); btn.disabled = false; }
        });
    }

    // --- åŠŸèƒ½ 4 (ç™¾åˆ†æ¯”å°ˆç”¨ç‰ˆ)ï¼šè¨ˆç®— ROI + åœ“é¤…åœ–é¡¯ç¤º % ---
    function loadAssetChart() {
        Promise.all([
            fetch(API_URL + "?tab=Portfolio").then(res => res.json()),
            fetch(API_URL + "?tab=Asset_Log").then(res => res.json())
        ]).then(([portfolioData, logData]) => {
            
            let currentMarketValue = 0; 
            let labels = [], values = [], colors = [];
            const palette = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF', '#E7E9ED', '#76D7C4', '#F1948A'];
            
            // 1. å»ºç«‹æˆæœ¬å°ç…§è¡¨
            let costMap = {};
            logData.forEach(row => {
                let cat = row.è³‡ç”¢é¡åˆ¥||"", item = row.é …ç›®åç¨±||row.é …ç›®||"", type = row.äº¤æ˜“å‹æ…‹||row.å‹æ…‹||"", amt = Number(row.é‡‘é¡);
                if ((cat.includes("è‚¡ç¥¨") || cat.includes("Stock") || item.includes("é»ƒé‡‘") || item.includes("BTC")) && !cat.includes("ç¾é‡‘")) {
                    if(!costMap[item]) costMap[item] = 0;
                    if (type.includes("æµå…¥") || type.includes("è²·å…¥")) costMap[item] += Math.abs(amt); 
                    else if (type.includes("æµå‡º") || type.includes("è³£å‡º")) costMap[item] -= Math.abs(amt); 
                }
            });

            globalSnapshotData = []; 
            let totalInvestCost = 0;

            portfolioData.forEach((row, i) => {
                let itemName = row['é …ç›®åç¨±'];
                let mv = Number(row['ç¸½å¸‚å€¼ (MarketValue)'] || row['ç¸½å¸‚å€¼'] || 0);
                let qty = row['æŒæœ‰æ•¸é‡/é‡‘é¡'] || row['æŒæœ‰æ•¸é‡'] || 0;
                let cost = costMap[itemName] || 0;

                if (mv > 0) {
                    currentMarketValue += mv;
                    labels.push(itemName); values.push(mv); colors.push(palette[i % palette.length]);
                }

                if (mv > 0 || (row['è³‡ç”¢é¡åˆ¥'] && row['è³‡ç”¢é¡åˆ¥'].includes('è‚¡ç¥¨'))) {
                    if(itemName.match(/00|é»ƒé‡‘|BTC|ETH|Stock/)) totalInvestCost += cost;
                    globalSnapshotData.push({ item: itemName, qty: qty, mv: mv, cost: cost });
                }
            });
            
            globalSnapshotData.push({ item: "ç¸½è³‡ç”¢", qty: 1, mv: currentMarketValue, cost: totalInvestCost });
            globalTotalAssets = currentMarketValue;

            // æ›´æ–°é€²åº¦æ¢
            let percent = Math.min(100, Math.round((currentMarketValue / SAVING_GOAL) * 100));
            const progBar = document.getElementById('goalProgressBar');
            if(progBar) {
                progBar.style.width = percent + "%";
                document.getElementById('goalPercent').innerText = percent + "%";
            }

            document.getElementById('totalAssetsDisplay').innerText = "$" + currentMarketValue.toLocaleString();
            document.getElementById('totalCostDisplay').innerText = "$" + totalInvestCost.toLocaleString();
            
            let profit = currentMarketValue - totalInvestCost;
            let pEl = document.getElementById('totalProfitDisplay');
            pEl.innerText = (profit >= 0 ? "+" : "") + "$" + profit.toLocaleString();
            pEl.style.color = profit >= 0 ? "#ff9999" : "#99ff99";

            let roi = totalInvestCost > 0 ? (profit / totalInvestCost) * 100 : 0;
            let rEl = document.getElementById('roiDisplay');
            rEl.innerText = (roi >= 0 ? "+" : "") + roi.toFixed(2) + "%";
            rEl.style.color = roi >= 0 ? "#ff9999" : "#99ff99";

            // --- ç•«åœ“é¤…åœ– ---
            const ctx = document.getElementById('assetPieChart');
            if(assetChart) assetChart.destroy();
            
            assetChart = new Chart(ctx, { 
                type: 'doughnut', 
                data: { 
                    labels: labels, 
                    datasets: [{ data: values, backgroundColor: colors }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { position: 'right' },
                        // ğŸŸ¢ é€™è£¡é‡å°åœ“é¤…åœ–ã€Œé–‹å•Ÿã€æ¨™ç±¤é¡¯ç¤º
                        datalabels: {
                            display: true, // åªæœ‰é€™è£¡è¨­ç‚º true
                            color: '#fff',
                            font: { weight: 'bold', size: 11 },
                            formatter: (value, ctx) => {
                                let sum = 0;
                                let dataArr = ctx.chart.data.datasets[0].data;
                                dataArr.map(data => { sum += data; });
                                let percentage = (value * 100 / sum).toFixed(1) + "%";
                                
                                // ä½”æ¯”å¤ªå° (<3%) éš±è—ä¸é¡¯ç¤ºï¼Œé¿å…é‡ç–Š
                                if((value * 100 / sum) < 3) return ""; 
                                return percentage;
                            }
                        }
                    } 
                } 
            });
        });
    }

    // --- åŠŸèƒ½ 5ï¼šé€å‡ºæ—¥å¸¸è¨˜å¸³ ---
    function submitExpense() {
        const btn = document.getElementById('btnExp');
        const vals = { tab: "Expenses_DB", date: document.getElementById('expDate').value || new Date().toISOString().split('T')[0], type: document.getElementById('expType').value, account: document.getElementById('expAccount').value, category: document.getElementById('expCategory').value, item: document.getElementById('expItem').value, amount: document.getElementById('expAmount').value };
        if(!vals.item || !vals.amount) { alert("è«‹è¼¸å…¥é …ç›®å’Œé‡‘é¡"); return; }
        btn.innerText = "å¯«å…¥ä¸­..."; btn.disabled = true;
        fetch(API_URL, { method: 'POST', body: JSON.stringify(vals) }).then(res => res.text()).then(data => {
            if (data.includes("Success")) { alert("ğŸ’¸ è¨˜å¸³æˆåŠŸï¼"); btn.disabled = false; btn.innerText = "è¨˜ä¸€ç­†"; document.getElementById('expItem').value = ""; document.getElementById('expAmount').value = ""; loadExpenses(); loadExpenseComparison(); loadAccountBalances(); loadTrendChart(); } 
            else { alert("å¤±æ•—ï¼š" + data); btn.disabled = false; }
        });
    }

    // --- åŠŸèƒ½ 6ï¼šè®€å–è¨˜å¸³åˆ—è¡¨ ---
    function loadExpenses() {
        fetch(API_URL + "?tab=Expenses_DB").then(res => res.json()).then(data => {
            const list = document.getElementById('expenseList'); list.innerHTML = ""; 
            if(data.length === 0) { list.innerHTML = "<li style='color:#ccc'>ç„¡ç´€éŒ„</li>"; return; }
            data.slice(-10).reverse().forEach(row => {
                const color = row.æ”¶æ”¯ === "æ”¶å…¥" ? "#4caf50" : "#e91e63"; const sign = row.æ”¶æ”¯ === "æ”¶å…¥" ? "+" : "-";
                list.innerHTML += `<li style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;"><div><span style="font-weight:bold; color:#555;">${row.é …ç›®}</span><span style="font-size:0.85em; color:#999; margin-left:5px;">(${row.æ—¥æœŸ})</span><br><span style="font-size:0.85em; background:#f0f0f0; padding:2px 6px; border-radius:4px;">(${formatDate(row.æ—¥æœŸ)})${row.é¡åˆ¥}</span><span style="font-size:0.85em; background:#f0f0f0; padding:2px 6px; border-radius:4px;">${row.å¸³æˆ¶}</span></div><div style="font-weight:bold; color:${color};">${sign}$${row.é‡‘é¡}</div></li>`;
            });
        });
    }

    // --- åŠŸèƒ½ 7 (é ç®—ç›£æ§ç‰ˆ)ï¼šæ”¯å‡ºæ¯”è¼ƒ + é ç®—é€²åº¦æ¢ ---
    function loadExpenseComparison() {
        fetch(API_URL + "?tab=Expenses_DB").then(res => res.json()).then(data => {
            if(data.length === 0) return;
            const now = new Date(); const cmKey = `${now.getFullYear()}/${now.getMonth() + 1}`;
            let lmYear = now.getFullYear(), lmMonth = now.getMonth(); if (lmMonth === 0) { lmYear -= 1; lmMonth = 12; } const lmKey = `${lmYear}/${lmMonth}`;
            const cats = ['é£Ÿ', 'è¡£', 'ä½', 'è¡Œ', 'è‚²æ¨‚', 'å…¶ä»–'];
            let stats = { tm: { 'é£Ÿ':0, 'è¡£':0, 'ä½':0, 'è¡Œ':0, 'è‚²æ¨‚':0, 'å…¶ä»–':0, 'total': 0 }, lm: { 'é£Ÿ':0, 'è¡£':0, 'ä½':0, 'è¡Œ':0, 'è‚²æ¨‚':0, 'å…¶ä»–':0, 'total': 0 } };
            
            data.forEach(row => {
                if (row.æ”¶æ”¯ !== "æ”¯å‡º") return; 
                let d = new Date(row.æ—¥æœŸ); let rKey = !isNaN(d.getTime()) ? `${d.getFullYear()}/${d.getMonth()+1}` : "";
                
                // æ—¥æœŸé˜²å‘†
                if(typeof row.æ—¥æœŸ === 'string' && row.æ—¥æœŸ.includes("/")) {
                     let parts = row.æ—¥æœŸ.split("/");
                     let y = parts.length===3 ? parts[0] : now.getFullYear();
                     let m = parts.length===3 ? parts[1] : parts[0];
                     rKey = `${y}/${parseInt(m)}`;
                }

                let c = cats.includes(row.é¡åˆ¥) ? row.é¡åˆ¥ : "å…¶ä»–"; let amt = Number(row.é‡‘é¡);
                if (rKey === cmKey) { stats.tm[c]+=amt; stats.tm.total+=amt; } else if (rKey === lmKey) { stats.lm[c]+=amt; stats.lm.total+=amt; }
            });

            // 1. æ›´æ–°æœ¬æœˆç¸½æ”¯å‡ºæ•¸å­—
            document.getElementById('monthExpenseDisplay').innerText = "$" + stats.tm.total.toLocaleString();
            
            // ==========================================
            // ğŸŸ¢ 2. æ›´æ–°é ç®—é€²åº¦æ¢ (Budget Logic)
            // ==========================================
            const currentExpense = stats.tm.total;
            const remain = MONTHLY_BUDGET - currentExpense;
            let percent = Math.round((currentExpense / MONTHLY_BUDGET) * 100);
            
            // é˜²æ­¢é€²åº¦æ¢çˆ†å‡ºå»
            let barWidth = percent > 100 ? 100 : percent;

            document.getElementById('budgetLimit').innerText = MONTHLY_BUDGET.toLocaleString();
            document.getElementById('budgetPercent').innerText = percent + "%";
            document.getElementById('budgetBar').style.width = barWidth + "%";
            
            const msgEl = document.getElementById('budgetMessage');
            if (remain >= 0) {
                msgEl.innerText = `âœ… é‚„å‰© $${remain.toLocaleString()} å¯èŠ±`;
                // é ç®—å…§é¡¯ç¤ºç™½è‰²æ¢
                document.getElementById('budgetBar').style.backgroundColor = "#fff";
            } else {
                msgEl.innerText = `âš ï¸ å·²è¶…æ”¯ $${Math.abs(remain).toLocaleString()} !`;
                // è¶…æ”¯é¡¯ç¤ºé»ƒè‰²è­¦ç¤º (åœ¨ç´…è‰²èƒŒæ™¯ä¸Šæ¯”è¼ƒæ˜é¡¯)
                document.getElementById('budgetBar').style.backgroundColor = "#ffeb3b";
            }
            // ==========================================

            document.getElementById('lastMonthTotalDisplay').innerText = "$" + stats.lm.total.toLocaleString();
            let diff = stats.tm.total - stats.lm.total;
            document.getElementById('totalDiff').innerHTML = diff > 0 ? `<span style="color:red">å¤šèŠ± $${diff.toLocaleString()}</span>` : `<span style="color:green">çœä¸‹ $${Math.abs(diff).toLocaleString()}</span>`;
            
            const ctx = document.getElementById('expenseCompareChart'); if(compareChart) compareChart.destroy();
            compareChart = new Chart(ctx, { type: 'bar', data: { labels: cats, datasets: [{ label: 'æœ¬æœˆ', data: cats.map(c=>stats.tm[c]), backgroundColor: '#36a2eb' }, { label: 'ä¸Šæœˆ', data: cats.map(c=>stats.lm[c]), backgroundColor: '#ff6384' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } });
            
            const body = document.getElementById('compareTableBody'); body.innerHTML = "";
            cats.forEach(c => { let v1 = stats.tm[c], v2 = stats.lm[c], d = v1-v2, dStr = d > 0 ? `<span style="color:red">â–² ${d}</span>` : (d<0 ? `<span style="color:green">â–¼ ${Math.abs(d)}</span>` : "-"); body.innerHTML += `<tr><td style="padding:8px;font-weight:bold">${c}</td><td>$${v1}</td><td style="color:#888">$${v2}</td><td>${dStr}</td></tr>`; });
        });
    }

    // --- åŠŸèƒ½ 8 (é¡¯ç¤ºç‰ˆ)ï¼šæ¯æœˆæ”¶å…¥ä¾†æºåˆ†æ ---

    function loadMonthlyIncome() {
        fetch(API_URL + "?tab=Asset_Log")
            .then(res => res.json())
            .then(data => {
                if(data.length === 0) return;

                let monthlyData = {}; 

                data.forEach(row => {
                    let amount = Number(row.é‡‘é¡);
                    if (amount <= 0) return; 

                    let account = row.å¸³æˆ¶ || "";
                    let category = row.è³‡ç”¢é¡åˆ¥ || row.é¡åˆ¥ || "";
                    if (!account.includes("éƒµå±€") && !account.includes("éŠ€è¡Œ") && !account.includes("ç¾é‡‘") && category !== "ç¾é‡‘") return;

                    let dateStr = row.æ—¥æœŸ;
                    let monthKey = "";
                    try {
                        let dateObj = new Date(dateStr);
                        let y = dateObj.getFullYear();
                        let m = String(dateObj.getMonth() + 1).padStart(2, '0');
                        if (isNaN(y)) return;
                        monthKey = `${y}/${m}`;
                    } catch (e) { return; }

                    if (!monthlyData[monthKey]) monthlyData[monthKey] = { salary: 0, invest: 0 };

                    let item = row.é …ç›®åç¨± || row.é …ç›® || "";
                    
                    if (item.includes("è³£å‡º") || item.includes("å­˜éŒ¢") || item.includes("è½‰å…¥") || item.includes("é ˜éŒ¢") || item.includes("æ›åŒ¯")) return; 

                    if (item.includes("è‚¡åˆ©") || item.includes("åˆ©æ¯") || item.includes("è‚¡æ¯")) {
                        monthlyData[monthKey].invest += amount;
                    } else if (item.includes("è–ª") || item.includes("å·¥è®€") || item.includes("çé‡‘") || item.includes("ç›£è€ƒ") || item.includes("æ™®ç™¼") || item.includes("å®¶æ•™") || item.includes("åŠ©æ•™") || item.includes("æ‰“å·¥")) {
                        monthlyData[monthKey].salary += amount;
                    }
                });

                let sortedMonths = Object.keys(monthlyData).sort();
                let salaryArr = sortedMonths.map(m => monthlyData[m].salary);
                let investArr = sortedMonths.map(m => monthlyData[m].invest);

                const ctx = document.getElementById('incomeSourceChart');
                if (incomeChart) incomeChart.destroy();

                incomeChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sortedMonths,
                        datasets: [
                            { label: 'è–ªè³‡/ä¸»å‹•æ”¶å…¥', data: salaryArr, backgroundColor: '#36A2EB', stack: 'Stack 0' },
                            { label: 'æŠ•è³‡/è¢«å‹•æ”¶å…¥', data: investArr, backgroundColor: '#FFCE56', stack: 'Stack 0' }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        // ğŸŸ¢ é—œéµä¿®æ”¹ 1ï¼šäº’å‹•æ¨¡å¼
                        interaction: {
                            mode: 'index',      // åªè¦æ»‘é¼ åœ¨è©²æœˆä»½çš„ X è»¸ä¸Šï¼Œå°±é¡¯ç¤ºæ‰€æœ‰æ•¸æ“š
                            intersect: false,   // ä¸ç”¨ç²¾æº–æŒ‡åˆ°è‰²å¡Šä¹Ÿèƒ½è§¸ç™¼
                        },
                        // ğŸŸ¢ é—œéµä¿®æ”¹ 2ï¼šå„ªåŒ–æç¤ºæ¡† (åŠ ä¸Š $ ç¬¦è™Ÿå’Œåƒåˆ†ä½)
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            // è®Šæˆ $12,345 æ ¼å¼
                                            label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }
                    }
                });
            });
    }

    // --- åŠŸèƒ½ 9ï¼šè¨ˆç®—é¤˜é¡ ---
    function loadAccountBalances() {
        Promise.all([fetch(API_URL+"?tab=Asset_Log").then(r=>r.json()), fetch(API_URL+"?tab=Expenses_DB").then(r=>r.json())]).then(([aData, eData]) => {
            let bal = {};
            aData.forEach(r => { let a=r.å¸³æˆ¶; if(a) bal[a] = (bal[a]||0) + Number(r.é‡‘é¡); });
            eData.forEach(r => { let a=r.å¸³æˆ¶, amt=Number(r.é‡‘é¡); if(a) { if(r.æ”¶æ”¯==="æ”¯å‡º") bal[a] = (bal[a]||0) - amt; else bal[a] = (bal[a]||0) + amt; } });
            const livingAcc = ["éŒ¢åŒ…", "ä¸­åœ‹ä¿¡è¨—", "icash", "ipassmoney", "å­¸ç”Ÿè­‰", "æ‚ éŠå¡", "ä¸€å¡é€š"];
            let liveTotal = 0; livingAcc.forEach(a => liveTotal += (bal[a]||0));
            document.getElementById('livingFundsDisplay').innerText = "$" + liveTotal.toLocaleString();
            const box = document.getElementById('accountBalanceContainer'); box.innerHTML = "";
            const sortList = [...livingAcc, "éƒµå±€", "å¯Œé‚¦éŠ€è¡Œ", "å¯Œé‚¦è­‰åˆ¸", "å¾…ä»˜æ¬¾"];
            Object.keys(bal).sort((a,b) => (sortList.indexOf(a)===-1?99:sortList.indexOf(a)) - (sortList.indexOf(b)===-1?99:sortList.indexOf(b))).forEach(a => { let v = bal[a], c = v>=0?"#333":"#e91e63"; box.innerHTML += `<div style="background:#f8f9fa;padding:15px;border-radius:8px;text-align:center;border:1px solid #eee;"><div style="font-size:0.9em;color:#666;margin-bottom:5px;">${a}</div><div style="font-size:1.2em;font-weight:bold;color:${c}">$${v.toLocaleString()}</div></div>`; });
        });
    }

    // --- åŠŸèƒ½ 10ï¼šè½‰å¸³ ---
    function submitTransfer() {
        const btn = document.getElementById('btnTrans');
        const vals = { date: document.getElementById('transDate').value || new Date().toISOString().split('T')[0], from: document.getElementById('transFrom').value, to: document.getElementById('transTo').value, amt: document.getElementById('transAmount').value };
        if(!vals.amt || vals.from === vals.to) { alert("é‡‘é¡éŒ¯èª¤"); return; }
        btn.innerText = "è™•ç†ä¸­..."; btn.disabled = true;
        const pOut = { tab:"Asset_Log", date:vals.date, account:vals.from, category:"ç¾é‡‘", item:"è½‰å‡º->"+vals.to, qty:"", amount:-Math.abs(vals.amt), type:"æµå‡º" };
        const pIn = { tab:"Asset_Log", date:vals.date, account:vals.to, category:"ç¾é‡‘", item:"è½‰å…¥<-"+vals.from, qty:"", amount:Math.abs(vals.amt), type:"æµå…¥" };
        Promise.all([fetch(API_URL, { method:'POST', body:JSON.stringify(pOut) }), fetch(API_URL, { method:'POST', body:JSON.stringify(pIn) })]).then(() => { alert("è½‰å¸³æˆåŠŸï¼"); btn.innerText="ç¢ºèª"; btn.disabled=false; document.getElementById('transAmount').value=""; loadAssetChart(); loadAccountBalances(); });
    }

    // --- åŠŸèƒ½ 11ï¼šå¤šè³‡ç”¢èµ°å‹¢åœ– + è²¡å¯Œé æ¸¬ ---
    function loadTrendChart() {
        Promise.all([
            fetch(API_URL + "?tab=History_Log").then(r=>r.json())
        ]).then(([histData]) => {
            if(histData.length === 0) return;

            let groupedData = {};
            let allDates = new Set();
            
            // å°ˆé–€çµ¦é æ¸¬ç”¨çš„é™£åˆ—
            let totalAssetRecords = []; 

            histData.forEach(r => {
                let dStr = r.æ—¥æœŸ; 
                if(!dStr) return;
                
                // æ—¥æœŸçµ±ä¸€è™•ç† (YYYY/MM/DD)
                // ç‚ºäº†æ’åºæº–ç¢ºï¼Œé€™è£¡åŒæ™‚å­˜ "å­—ä¸²(çµ¦åœ–è¡¨ç”¨)" å’Œ "æ™‚é–“æˆ³(çµ¦è¨ˆç®—ç”¨)"
                let dObj = new Date(dStr);
                let dateKey = "";
                let ts = 0;

                if(!isNaN(dObj.getTime())) {
                    dateKey = dStr; // å¦‚æœåŸæœ¬å°±æ˜¯æ¨™æº–æ ¼å¼
                    ts = dObj.getTime();
                } else if (typeof dStr === 'string') {
                    // è™•ç†åƒ 2025/11/1 é€™ç¨®æ ¼å¼
                    dateKey = dStr;
                    let parts = dStr.split(/[-/]/);
                    if(parts.length >= 3) {
                        ts = new Date(parts[0], parts[1]-1, parts[2]).getTime();
                    }
                }

                if(!dateKey) return; // æ—¥æœŸç„¡æ•ˆå°±è·³é

                allDates.add(dateKey);
                let item = r.è³‡ç”¢åç¨±;
                let val = Number(r.ç¾æ·¨å€¼);

                // 1. çµ¦åœ–è¡¨ç”¨çš„åˆ†çµ„è³‡æ–™
                if(!groupedData[item]) groupedData[item] = {};
                groupedData[item][dateKey] = val;

                // 2. çµ¦é æ¸¬ç”¨çš„è³‡æ–™ (åªæŠ“ç¸½è³‡ç”¢)
                if (item === "ç¸½è³‡ç”¢" && val > 0) {
                    totalAssetRecords.push({ ts: ts, val: val, dateStr: dateKey });
                }
            });

            // ==========================================
            // è²¡å¯Œé æ¸¬é‚è¼¯
            // ==========================================
            // å…ˆæŒ‰æ™‚é–“æ’åº
            totalAssetRecords.sort((a, b) => a.ts - b.ts);
            
            // é€²è¡Œé æ¸¬ (éœ€è¦è‡³å°‘ 2 ç­†è³‡æ–™)
            const predEl = document.getElementById('predictionText');
            
            if (predEl && totalAssetRecords.length >= 2) {
                let first = totalAssetRecords[0]; 
                let last = totalAssetRecords[totalAssetRecords.length - 1];
                
                // è¨ˆç®—å·®è· (å¤©æ•¸)
                let daysDiff = (last.ts - first.ts) / (1000 * 60 * 60 * 24);
                let moneyDiff = last.val - first.val;
                
                // é¿å…æ™‚é–“å¤ªçŸ­å°è‡´èª¤å·®ï¼Œå»ºè­°å¤§æ–¼ 14 å¤©å†ç®—
                if (daysDiff > 14) {
                    // å¹³å‡æœˆæˆé•· = ç¸½æˆé•·é‡‘é¡ / (ç¸½å¤©æ•¸ / 30)
                    let growthSpeed = moneyDiff / (daysDiff / 30); 
                    let remaining = SAVING_GOAL - last.val; // SAVING_GOAL æ˜¯å…¨åŸŸè®Šæ•¸ (ä¾‹å¦‚ 100è¬)
                    
                    if (remaining > 0 && growthSpeed > 0) {
                        let monthsNeeded = remaining / growthSpeed;
                        let targetDate = new Date();
                        targetDate.setMonth(targetDate.getMonth() + Math.ceil(monthsNeeded));
                        let targetDateStr = `${targetDate.getFullYear()}å¹´ ${targetDate.getMonth() + 1}æœˆ`;
                        
                        predEl.innerHTML = `ğŸš€ å¹³å‡æœˆå¢ <b style="color:#2E86C1">$${Math.round(growthSpeed).toLocaleString()}</b>ï¼Œé è¨ˆ <b style="color:#27AE60">${targetDateStr}</b> é”æ¨™ï¼`;
                    } else if (remaining <= 0) {
                        predEl.innerHTML = `ğŸ‰ æ­å–œï¼ä½ å·²ç¶“é”æˆç›®æ¨™äº†ï¼`;
                    } else {
                        predEl.innerHTML = `ğŸ“‰ è³‡ç”¢æš«æ™‚ç¸®æ°´ (æœˆæ¸› $${Math.round(Math.abs(growthSpeed)).toLocaleString()})ï¼Œç¹¼çºŒåŠ æ²¹ï¼`;
                    }
                } else {
                    predEl.innerText = "â³ æ•¸æ“šç´¯ç©ä¸­ï¼Œä¸‹å€‹æœˆå†ä¾†æŸ¥çœ‹é æ¸¬ã€‚";
                }
            } else if (predEl) {
                predEl.innerText = "ğŸ’¡ ç´¯ç©å…©ç­†ä»¥ä¸Šçš„ç¸½è³‡ç”¢å¿«ç…§å¾Œï¼Œå°‡å•Ÿå‹•é æ¸¬åŠŸèƒ½ã€‚";
            }
            // ==========================================

            let sortedDates = Array.from(allDates).sort((a, b) => new Date(a) - new Date(b));
            
            // 3. æº–å‚™ç¹ªåœ– Datasets
            let datasets = [];
            const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF'];
            let colorIdx = 0;

            // å…ˆåŠ  "ç¸½è³‡ç”¢" (æŠŠå®ƒæ”¾ç¬¬ä¸€ï¼Œç”¨é»‘è‰²ç²—ç·š)
            if(groupedData["ç¸½è³‡ç”¢"]) {
                datasets.push({
                    label: "ç¸½è³‡ç”¢",
                    data: sortedDates.map(d => groupedData["ç¸½è³‡ç”¢"][d] || null),
                    borderColor: "#333", // é»‘è‰²ç·š
                    borderWidth: 3,
                    tension: 0.1,
                    pointRadius: 4,
                    yAxisID: 'y'
                });
                delete groupedData["ç¸½è³‡ç”¢"]; // ç§»å‡ºæ¸…å–®ï¼Œä»¥å…ä¸‹é¢é‡è¤‡ç•«
            }

            // å†åŠ å…¶ä»–è³‡ç”¢ (0050, 0056...)
            for(let item in groupedData) {
                datasets.push({
                    label: item,
                    data: sortedDates.map(d => groupedData[item][d] || null),
                    borderColor: colors[colorIdx % colors.length],
                    backgroundColor: colors[colorIdx % colors.length],
                    borderWidth: 2,
                    tension: 0.1,
                    pointRadius: 3,
                    yAxisID: 'y' 
                });
                colorIdx++;
            }

            const ctx = document.getElementById('trendChart');
            if(trendChart) trendChart.destroy();

            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: { 
                            type: 'linear', 
                            display: true, 
                            position: 'left', 
                            title: { display: true, text: 'å¸‚å€¼ (TWD)' } 
                        }
                    },
                    plugins: { 
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        });
    }

    // --- ğŸŸ¢ åŠŸèƒ½ 12ï¼šæ‰¹æ¬¡å¯«å…¥å¿«ç…§  ---
    function snapshotAssets() {
        if(!globalSnapshotData || globalSnapshotData.length === 0) { 
            alert("è³‡ç”¢æ•¸æ“šè¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦"); 
            return; 
        }
        
        const btn = document.getElementById('btnSnapshot');
        btn.innerText = "å„²å­˜ä¸­..."; btn.disabled = true;

        const today = new Date().toISOString().split('T')[0];
        
        // æº–å‚™äºŒç¶­é™£åˆ—è³‡æ–™
        let rowsToSend = globalSnapshotData.map(item => {
            let finalName = item.item;
            
            // ğŸŸ¢ é—œéµä¿®æ­£ï¼šå¦‚æœåç¨±æ˜¯ "0" é–‹é ­çš„æ•¸å­— (ä¾‹å¦‚ 0050)ï¼Œå‰é¢åŠ å–®å¼•è™Ÿ
            // é€™æ¨£ Excel æ‰æœƒæŠŠå®ƒç•¶æˆæ–‡å­—ï¼Œä¿ç•™å‰é¢çš„ 0
            if (String(finalName).startsWith("0") && !isNaN(finalName)) {
                finalName = "'" + finalName;
            }

            return [today, finalName, item.qty, item.mv, item.cost];
        });

        const payload = {
            tab: "History_Log",
            rows: rowsToSend 
        };
        
        fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) })
        .then(res => res.text())
        .then(data => {
            if(data.includes("Success")) {
                alert("ğŸ“¸ æˆåŠŸç´€éŒ„ï¼");
                btn.innerText = "ğŸ“¸ ç´€éŒ„æœ¬æœˆè©³ç´°å¿«ç…§";
                btn.disabled = false;
                loadTrendChart();
            } else {
                alert("å¤±æ•—ï¼š" + data);
                btn.disabled = false;
            }
        });
    }

    // --- ğŸŸ¢ åŠŸèƒ½ 13ï¼šåˆ‡æ›è¼¸å…¥æ¡†é¡¯ç¤º/éš±è— ---
    function toggleMediaForm() {
        const form = document.getElementById('mediaForm');
        form.style.display = form.style.display === "none" ? "flex" : "none";
    }

    // --- ğŸŸ¢ åŠŸèƒ½ 14ï¼šé€å‡ºåª’é«”ç´€éŒ„ ---
    function submitMedia() {
        const btn = event.target; 
        btn.innerText = "å„²å­˜ä¸­..."; btn.disabled = true;
        
        const payload = {
            tab: "Media_Log",
            date: document.getElementById('mediaDate').value || new Date().toISOString().split('T')[0],
            type: document.getElementById('mediaType').value,
            title: document.getElementById('mediaTitle').value,
            rating: document.getElementById('mediaRating').value,
            comment: document.getElementById('mediaComment').value
        };

        if(!payload.title) { alert("è«‹è¼¸å…¥æ¨™é¡Œ"); btn.disabled=false; return; }

        fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) })
        .then(res => res.text()).then(data => {
            if(data.includes("Success")) {
                alert("ğŸ“š ç´€éŒ„æˆåŠŸï¼");
                btn.innerText = "å„²å­˜åˆ°æ›¸æ«ƒ"; btn.disabled = false;
                document.getElementById('mediaTitle').value = "";
                document.getElementById('mediaComment').value = "";
                toggleMediaForm(); // æ”¶èµ·è¡¨å–®
                loadMediaList();   // é‡æ–°è¼‰å…¥åˆ—è¡¨
            } else { alert("å¤±æ•—ï¼š" + data); btn.disabled = false; }
        });
    }

    // --- ğŸŸ¢ åŠŸèƒ½ 15ï¼šè®€å–ä¸¦é¡¯ç¤ºå¡ç‰‡ç‰† ---
    function loadMediaList() {
        fetch(API_URL + "?tab=Media_Log").then(res => res.json()).then(data => {
            const container = document.getElementById('mediaContainer');
            container.innerHTML = "";
            
            if(data.length === 0) { container.innerHTML = "<div style='color:#ccc'>é‚„æ²’æœ‰ç´€éŒ„ï¼Œå¿«å»é–±è®€å§ï¼</div>"; return; }

            // åè½‰é †åºï¼Œè®“æœ€æ–°çš„åœ¨æœ€ä¸Šé¢
            data.reverse().forEach(row => {
                let stars = "â­".repeat(Number(row.è©•åˆ†));
                let icon = "ğŸ“„";
                if(row.é¡åˆ¥ === "æ›¸ç±") icon = "ğŸ“–";
                if(row.é¡åˆ¥ === "é›»å½±") icon = "ğŸ¬";
                if(row.é¡åˆ¥ === "èª²ç¨‹") icon = "ğŸ“";

                let cardHtml = `
                    <div style="background:#f8f9fa; padding:15px; border-radius:10px; border-left: 4px solid #607d8b; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span style="font-size:0.85em; color:#666; background:#e0e0e0; padding:2px 6px; border-radius:4px;">${icon} ${row.é¡åˆ¥}</span>
                            <span style="font-size:0.85em; color:#999;">${row.æ—¥æœŸ}</span>
                        </div>
                        <div style="font-weight:bold; font-size:1.1em; margin-bottom:5px; color:#333;">${row.æ¨™é¡Œ}</div>
                        <div style="color:#f39c12; font-size:0.9em; margin-bottom:8px;">${stars}</div>
                        <div style="font-size:0.9em; color:#555; font-style:italic;">"${row.å¿ƒå¾—}"</div>
                    </div>
                `;
                container.innerHTML += cardHtml;
            });
        });
    }

    // --- ğŸŸ¢ åŠŸèƒ½ 16ï¼šæ™‚é–“å€’æ•¸å°å·¥å…· ---
    function loadTimeWidget() {
        // 1. å…ˆç•«å¹´åº¦é€²åº¦æ¢
        const container = document.getElementById('timeContainer');
        if(!container) return;
        
        const now = new Date();
        const currentYear = now.getFullYear();
        const startOfYear = new Date(currentYear, 0, 1);
        const endOfYear = new Date(currentYear + 1, 0, 1);
        const yearPercent = ((now - startOfYear) / (endOfYear - startOfYear)) * 100;
        
        let html = `
            <div>
                <div style="display:flex; justify-content:space-between; font-size:0.9em; margin-bottom:5px;">
                    <span>${currentYear}å¹´ å·²é</span>
                    <span>${yearPercent.toFixed(1)}%</span>
                </div>
                <div style="width:100%; background:rgba(255,255,255,0.2); border-radius:10px; height:8px;">
                    <div style="height:100%; background:#fff; width:${yearPercent}%; border-radius:10px; transition:width 1s;"></div>
                </div>
            </div>
        `;

        // 2. å¾å¾Œç«¯æŠ“å– Events_DB
        fetch(API_URL + "?tab=Events_DB")
            .then(res => res.json())
            .then(data => {
                if(data.length === 0) {
                    container.innerHTML = html + "<div style='text-align:center; font-size:0.8em; opacity:0.7; margin-top:10px;'>å°šç„¡å€’æ•¸äº‹ä»¶</div>";
                    return;
                }

                data.forEach(event => {
                    let targetDate;
                    let evtTitle = event['äº‹ä»¶åç¨±'] || event['title']; 
                    let evtDate = event['æ—¥æœŸ'] || event['date'];
                    let evtType = event['é¡å‹'] || event['type'];

                    // æ—¥æœŸå­—ä¸²è™•ç†
                    let dateStr = String(evtDate).replace(/\//g, "-").split("T")[0];

                    if (evtType === "fixed") {
                        // å›ºå®šæ—¥æœŸ
                        targetDate = new Date(dateStr);
                    } else {
                        // æ¯å¹´é‡è¤‡ (è™•ç† 10-25 æˆ– 2025-10-25)
                        let shortDate = dateStr.includes("-") ? dateStr.slice(-5) : dateStr; 
                        const [m, d] = shortDate.split('-');
                        targetDate = new Date(currentYear, m - 1, d);
                        if (now > targetDate) targetDate.setFullYear(currentYear + 1);
                    }

                    // è¨ˆç®—å‰©é¤˜å¤©æ•¸
                    const diffTime = targetDate - now;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (diffDays < 0 && evtType === "fixed") return; 

                    // ğŸŸ¢ é—œéµä¿®æ­£ï¼šä½¿ç”¨ formatDate() çµ±ä¸€é¡¯ç¤ºæ ¼å¼ (YYYY/MM/DD)
                    let displayDate = formatDate(targetDate);

                    html += `
                        <div style="display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.1); padding:10px 15px; border-radius:10px;">
                            <div>
                                <div style="font-size:0.85em; opacity:0.8;">${evtTitle}</div>
                                <div style="font-size:1.1em; font-weight:bold;">${displayDate}</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:0.85em; opacity:0.8;">é‚„å‰©ä¸‹</div>
                                <div style="font-size:1.5em; font-weight:bold; color:#ffeb3b;">
                                    ${diffDays > 0 ? diffDays : 0} <span style="font-size:0.6em;">å¤©</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            })
            .catch(err => {
                console.error(err);
                container.innerHTML = html + "<div style='text-align:center; font-size:0.8em; opacity:0.7;'>è®€å–éŒ¯èª¤</div>";
            });
    }

    // --- ğŸŸ¢ åŠŸèƒ½ 17ï¼šæ–°å¢å€’æ•¸äº‹ä»¶ ---
    function toggleEventForm() {
        const form = document.getElementById('eventForm');
        form.style.display = form.style.display === "none" ? "flex" : "none";
    }

    function submitEvent() {
        const btn = event.target; btn.innerText = "è™•ç†ä¸­..."; btn.disabled = true;
        const title = document.getElementById('evtTitle').value;
        const date = document.getElementById('evtDate').value;
        const type = document.getElementById('evtType').value;

        if(!title || !date) { alert("è«‹å¡«å¯«å®Œæ•´"); btn.disabled=false; return; }

        const payload = {
            tab: "Events_DB",
            title: title,
            date: date,
            type: type
        };

        fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) })
        .then(res => res.text()).then(data => {
            if(data.includes("Success")) {
                alert("â³ æ–°å¢æˆåŠŸï¼");
                btn.innerText = "ç¢ºèªæ–°å¢"; btn.disabled = false;
                document.getElementById('evtTitle').value = "";
                document.getElementById('evtDate').value = "";
                toggleEventForm(); // æ”¶èµ·
                loadTimeWidget();  // é‡æ•´
            } else { alert("å¤±æ•—ï¼š" + data); btn.disabled = false; }
        });
    }

    // --- åŠŸèƒ½ 18ï¼šå¤¢æƒ³è³¼ç‰©è»Š (è³¼è²·å¾Œè‡ªå‹•éš±è—) ---
    function loadWishlist() {
        const livingEl = document.getElementById('livingFundsDisplay');
        let livingText = livingEl ? livingEl.innerText : "0";
        
        if (livingText.includes("è¨ˆç®—ä¸­")) { setTimeout(loadWishlist, 500); return; }

        let currentCash = Number(livingText.replace(/[$,]/g, "")) || 0;

        fetch(API_URL + "?tab=Wishlist_DB").then(res => res.json()).then(data => {
            const container = document.getElementById('wishlistContainer');
            container.innerHTML = "";
            
            if(data.length === 0) { container.innerHTML = "<div style='color:#ccc; text-align:center;'>ç›®å‰æ²’æœ‰é¡˜æœ›ï¼Œå¿«å»è¨±é¡˜å§ï¼</div>"; return; }

            data.forEach((row, index) => {
                let itemName = row['é …ç›®åç¨±'] || row['é …ç›®'] || row['item'] || "æœªå‘½å";
                let price = Number(row['é ä¼°é‡‘é¡'] || row['é‡‘é¡'] || row['amount'] || 0);
                let diff = currentCash - price;
                let statusHtml = "", cardBg = "#fff";

                if (diff >= 0) {
                    statusHtml = `<span style="color:#2e7d32; font-weight:bold; font-size:0.9em;">âœ… å¯è³¼è²· (å‰©é¤˜ $${diff.toLocaleString()})</span>`;
                    cardBg = "#e8f5e9"; 
                } else {
                    statusHtml = `<span style="color:#c62828; font-weight:bold; font-size:0.9em;">âŒ é‚„å·® $${Math.abs(diff).toLocaleString()}</span>`;
                }

                // ğŸŸ¢ ä¿®æ”¹é»ï¼šå‚³å…¥ 'this' ä»¥ä¾¿æŠ“å–æŒ‰éˆ•å…ƒç´ ï¼Œä¸¦çµ¦å¡ç‰‡ä¸€å€‹ ID
                let buyBtn = diff >= 0 ? 
                    `<button onclick="fillExpense('${itemName}', '${price}', this)" style="padding:5px 10px; font-size:0.8em; background:#4caf50; margin-left:10px; color:white; border:none; border-radius:5px; cursor:pointer;">è³¼è²·</button>` : 
                    ``;

                let html = `
                    <div id="wish-card-${index}" style="background:${cardBg}; padding:12px; border-radius:8px; border:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-weight:bold; color:#333; font-size:1.1em;">${itemName}</div>
                            <div style="font-size:0.9em; color:#666;">$${price.toLocaleString()}</div>
                            <div style="margin-top:2px;">${statusHtml}</div>
                        </div>
                        <div style="text-align:right;">
                            ${buyBtn}
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        });
    }

    // --- ğŸŸ¢ è¼”åŠ©åŠŸèƒ½ï¼šä¸€éµå¸¶å…¥è¨˜å¸³ä¸¦ç§»é™¤å¡ç‰‡ ---
    function fillExpense(item, price, btnElement) {
        // 1. è‡ªå‹•å¡«å…¥è¨˜å¸³å€
        document.getElementById('expItem').value = item;
        document.getElementById('expAmount').value = price;
        document.getElementById('expType').value = "æ”¯å‡º";
        
        // 2. æ»¾å‹•åˆ°è¨˜å¸³å€
        document.getElementById('expItem').scrollIntoView({behavior: "smooth"});
        
        // 3. ğŸŸ¢ è¦–è¦ºåˆªé™¤ï¼šæŠŠé‚£å¼µé¡˜æœ›å¡ç‰‡å¾ç¶²é ä¸Šç§»é™¤
        // æ‰¾åˆ°æŒ‰éˆ•å¾€ä¸Šæ•¸çš„çˆ¶å±¤ div (å¡ç‰‡)ï¼Œç„¶å¾Œåˆªæ‰å®ƒ
        if (btnElement) {
            let card = btnElement.closest('div[id^="wish-card-"]');
            if (card) {
                card.style.transition = "opacity 0.5s";
                card.style.opacity = "0"; // æ·¡å‡ºå‹•ç•«
                setTimeout(() => card.remove(), 500); // 0.5ç§’å¾Œå®Œå…¨ç§»é™¤
            }
        }
        
        // 4. æé†’ä½¿ç”¨è€…
        alert(`å·²å°‡ã€Œ${item}ã€å¸¶å…¥è¨˜å¸³å€ï¼\n\nâš ï¸ æ³¨æ„ï¼š\nç¶²é ä¸Šå·²ç¶“æš«æ™‚éš±è—æ­¤é¡˜æœ›ï¼Œ\nä½†åœ¨ Excel è£¡å®ƒé‚„åœ¨ï¼Œè«‹è¨˜å¾—å» Excel æ‰‹å‹•åˆªé™¤è©²è¡Œå–”ï¼`);
    }
</script>

</body>
</html>
